<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=.66, shrink-to-fit=yes">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
	<script src="/go/lib/jquery.ui.touch-punch.min.js"></script>
	<script src="/go/chat.js"></script>
	<script src="/go/register.js"></script>
	<script src="/./chat.js"></script>
	<script src="/./register.js"></script>
	<link REL="SHORTCUT ICON" HREF="img/favicon.ico">
	<title>èt•al small</title>

<!-- ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
SMALL
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////-->
	
</head>
<style>
	body 		{ 	font-family:Segoe UI,Verdana,Geneva,sans-serif; font-size:14px; padding:0; box-sizing:content-box; margin:0; }
	.co-splash 	{ 	position:absolute; width:100%; top:0; left:0; text-align:center; margin-top:15%; display:none; font-size:12px; }
	.co-top		{	opacity:0; overflow:hidden;height:100vh; z-index:0; }
	.co-avatar 	{	position:absolute; cursor:pointer; left:50%; top:50%; font-size:12px; text-align:center; user-select:none;
	 				line-height:1.2em; -webkit-user-select:none; }
	.co-me 		{	position:absolute; cursor:url(img/move.cur),auto; left:50%; top:50%; border-radius:64px; user-select:none; -webkit-user-select:none; }
	.co-qNum 	{	position:relative;color:#fff; text-align:center; font-size:9px; border-radius:16px; background-color:#ff0000; 
					cursor:pointer; width:11px; height:11px; display:none;  }
	.co-card 	{	position:absolute; width:300px; height:150px; background-color:#fff; border-radius:4px;
					border:1px solid #666; padding:12px; text-align:center; font-size:14px; box-shadow:2px 2px 4px #999; }
	.co-qlist 	{	position:absolute; width:274px; height:300px; background-color:#fff; border-radius:8px;
					border:1px solid #666; padding:12px; text-align:center; font-size:12px; box-shadow:2px 2px 4px #999; }
	.co-chat	{	position:absolute; width:230px; height:320px; background-color:#fff; border-radius:12px;
					border:1px solid #666; padding:12px; text-align:center; font-size:14px; box-shadow:2px 2px 4px #999; }
	.co-qlist 	{	position:absolute; width:274px; height:300px; background-color:#fff; border-radius:8px;
					border:1px solid #666; padding:12px; text-align:center; font-size:12px; box-shadow:2px 2px 4px #999; }
	.co-textR 	{	background-color:#dddddd; border-radius:16px; padding:4px 8px; width:fit-content; max-width: 66%; margin:4px 6px; clear:both; float:left;  text-align:left; }
	.co-textS 	{	background-color:#0099ff; border-radius:16px; padding:4px 8px; width:fit-content; max-width: 66%; margin:4px 6px; clear:both; float:right; text-align:right; color:#fff; }
	.co-is 		{	border-radius:16px; padding:0 8px; width:250px; height: 24px; border:1px solid #999; font-size: 13px; }
	.co-logon 	{	border-radius:16px; padding:0 8px; width:200px; height: 24px; border:1px solid #999; font-size: 13px; text-align:center; }
	.co-confirm {	position: absolute;  width: 300px; padding: 16px; left: calc(50% - 300px); top: calc(50% - 150px); user-select: none;	
					border-radius: 8px; background-color: #fff; border: 1px solid #999; }
	.co-alert	{	position:absolute; color:#fff; font-size:12px; text-align:center; cursor:pointer; padding:4px; top:8px; }
	.co-is 		{	border-radius:16px; padding:0 8px; height: 24px; border:1px solid #999; font-size: 13px; }
	.co-bs 		{	display:inline-block; border-radius:16px; padding:0 8px; border:1px solid #eee; font-size: 13px; 
					cursor:pointer; z-index:2; padding-bottom:1px; color:#fff}
	.co-bsg		{	cursor: pointer; color:#fff; text-align: center; border-radius: 16px; display: inline-block; user-select: none;
					font-size: 13px; background-color: #999; padding: 2px 8px 2px 8px; }
	.co-popup 	{	position: absolute;  width:auto; padding:12px; left:40%; top:calc(50% - 50px); border-radius:8px; display: none;
					background-color:#fff; border:1px solid #999; font-size:14px; text-align:center; max-width:33%; min-width:20%; }
	.co-iframe 	{	width:100%; height:calc(50vw * .5265); border-radius:4px; vertical-align:top; background-color:#444; } 
	.co-info	{	width:100%; height:100% }
	.co-hall	{	width:calc(100% - 24px); height:calc(100vh - 24px); border-radius:4px; 
					background-color:#d8c4ae; text-align:center; vertical-align:top; 
					user-select:none; -webkit-user-select:none; -ms-user-select:none; }
	.co-mroom	{	width:100%; height:calc(60vw * .5265); }
	.co-table	{	display:inline-block; width:20vw; height:20vw; border-radius:1000px; background-color:#a2733f; 
					margin:80px 0; text-align:center; color:#fff }
	.co-breakout{	display:inline-block; width:12vw; height:120px; border-radius:8px; 
					border:2px solid #a2733f; margin:6px; text-align:center; color:#a2733f}
	.co-topic	{	width:calc(100% - 48px); color:#fff; text-align:center; padding:12px 24px 0 24px; font-size:16px; }
	.co-docs	{	display:inline-block; width:calc(50% - 6px); height:calc(100vh - 50vw * .5265 - 36px); border-radius:4px; 
					background-color:#ddd; text-align:center; vertical-align:top; }
	.co-title	{	color:#333; text-align:center; font-size:24px; margin: 6px 0; }
	.co-items	{	color:#333; text-align:center; font-size:16px; margin-top:8px;
					overflow-x:hidden;overflow-y:auto; height:calc(100% - 70px); }
	.co-dash 	{	position:absolute; padding:24px; text-align:center;	width:calc(100vw - 72px); height:calc(100vh - 72px); top:12px; left:12px;
					border-radius:4px;  text-align:center; background-color:#d8c4ae; border: 1px solid #999; }
	.co-dashTable{ 	display:inline-block; width:calc(33% - 56px); border: 1px solid #999; padding:16px; vertical-align:top;
					border-radius:8px; height:calc(66vh); margin:12px; background-color:#f8f8f8; overflow-y:auto; }
	.co-dashText{	width:calc(100% - 36px); height:60%; padding:12px; font-size:15px; font-family:Segoe UI,sans-serif; }

	body ::-webkit-scrollbar { width: 9px; height:8px } 
	body ::-webkit-scrollbar-track { background: transparent; }
	body ::-webkit-scrollbar-thumb { border-radius:8px ;background:#a4baec }
	body ::-webkit-scrollbar-thumb:hover { background: #a4baec }

	@media only screen and (max-width:700px) {
		.co-top 	{ height:auto; overflow:auto }
		}


</style>
<body>

	<div id="co-top" class="co-top">
		<div id="co-main" style="width:100%;height:100%;margin:12px"></div>
	</div>
	<div id="splashDiv" class="co-splash">
		<img src="img/logo.png" alt="" style="width: 20%"><br><br>
		<p style="color:#000;font-size:14px"><em>A people centered group meeting tool</em></p>
		<br><br>
		<div id="co-splash2"><input type="text" id="co-logon" class="co-logon" placeholder="Type email to join"></div>
		<br><br>
		<b>For the best experience</b><br>Please use the Chrome or FoxFox browser<br>Use Safari on iPad
		<br><br>Click <a href="https://www.youtube.com/embed/7pI4bLNXrqE?rel=0&autoplay=1" target="_blank">here</a> to view a 90-second intro video
	</div>

<script>

	var	avSize=36;																					// Avatar size
	isSmall=false;																					// Mobile size flag
	var app=null;																					// Holds app
	const isLocal=(window.location.host == "localhost");											// Running locally?
	const goPath=isLocal ? "/./" : "/go/";															// Path to go folder

	$(window).on("resize orientationchange", ()=>{ if (app) app.Draw(); })                       	// ON WINDOW RESIZE/FLIP

	window.addEventListener("unload",  ()=>{ 													// ON CLOSE
		if (app.videoWin)	app.videoWin.close();													// Close video window if open
		app.ReportLocation(.5,.5, "Q"); 															// Close me out from server
		});

	function HTML5eventHandler(e)																// ON HTML5 EVENT
	{
		if (e.data && e.data.match(/VideoQuit/)) { $("#co-iframe").remove();  app.GoToCenter();	}	//  Quit video
	}

	$(document).ready(function() {								           							// ON PAGE LOADED
		if (window.addEventListener) 																// If supported this way
			window.addEventListener("message",HTML5eventHandler,false);								// Add event handler
		else																						// Use other method
			window.attachEvent("message",HTML5eventHandler);										// Add handler
		isMobile=navigator.userAgent.match(/(ipad|iphone|ipod|android)/i) ? true : false;			// Set mobile flag
		var url=window.location.search.substring(1);						   						// Get query string
		let meetingId=url ? url : "gdemo";															// Set meeting id
		app=new App(meetingId);                                      								// Alloc app
		$("#splashDiv").fadeIn();																	// Fade in splash
	
		$("#co-logon").on("change",()=>{															// ON LOGON
			let i,pid=$("#co-logon").val();															// Get value
			for (i=0;i<app.people.length;++i) 														// For each person
				if (app.people[i].email.trim().toLowerCase() == pid.trim().toLowerCase())			// If a match
					break;																			// Quit looking
			if (i == app.people.length) {															// Email not found
				alert("This email was not found, please try again, or contact your meeting host"); // Alert
				return;																				// Quit																				
				}
			if (!app.people[i].firstName) {															// If no name
				let reg=new Register(app.people[i]);												// Run registration code
				return;																				// Quit
				}
			app.JoinMeeting(app.people[i].id);														// Join meeting
			});
	
		$(window).on("keydown",function(e) {														// HANDLE KEYPRESS
			if ((e.which == 66) && e.altKey && e.ctrlKey) {											// Broadcast key (Ctrl+Alt+B)
				GetTextBox("Type or speak message","","",(s)=>{ app.ws.send(`B|${app.meetingId}|${app.people[app.myId].id}|`+s)});	// Broadcast
				}
			if ((e.which == 84) && e.altKey && e.ctrlKey) {											// Test key (Ctrl+Alt+T)
				}
			});
	});	
 
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// APP
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class App  {																					

	constructor(meetingId)   																	// CONSTRUCTOR
	{
		app=this;																					// App global pointer
		this.meetingId=""+meetingId;																// Meeting id
		this.myEmail="";																			// My email
		this.myId=0;																				// My unique id
		this.venue=[];																				// Holds floors
		this.people=[{ stats:"Q"} ];																// Holds attendees
		this.pIndex=[];																				// Get people index from id
		this.status="";																				// My status
		this.videoWin=null;																			// Video window
		this.retryWS=false;																			// Reconnecting to web socket
		this.curItem=2;																				// Current agenda item
		this.KZ="";																					// Ks
		this.curContent="";																			// Current floor's content
		this.coffeebarLink="";																		// Alternative link for main coffeebar
		if (isLocal) this.ws=new WebSocket('ws://'+window.location.host+':8080');					// Open insecure websocket											
		else		 this.ws=new WebSocket('wss://'+window.location.host+':8080');					// Secure											
		this.ws.onmessage=(e)=>{ this.SocketIn(e); };												// ON INCOMING MESSAGE
		this.ws.onclose=()=>   { this.retryWS=true; console.log('disconnected'); };					// ON CLOSE
		this.ws.onerror=(e)=> { 																	// ON ERROR
			console.log('error',e);
			let str=`<h1 style="color:#ff0000">There was a problem joining the meeting!</h1><p style="color:#000;font-size:14px;">
				Either the meeting server is down, or there may be a firewall blocking your access.<br><br>
				<b>Please contact you meeting's host for help.<b></p>`;
				$("#co-splash2").html(str); 
			};
		
		this.chat=new Chat();																		// Add chat class
		this.sced={}
		this.sced.ShowLink=this.SetLink;

		this.ws.onopen=()=> { 																		// ON OPEN
			if (this.meetingId != "preview") {														// If not previewing
				app.ws.send(`P|${app.meetingId}`);													// Request people data	
				app.ws.send(`S|${app.meetingId}`);													// Request schedule data 
				}
			app.ws.send(`KZ|*`);																	// Request zk data	
			console.log('connected');  
			};				
		
		this.secs=0;	
		this.pollTimer= window.setInterval( ()=>{													// Init polling timer
			++this.secs;																			// Another second 
			if ((this.secs%15) == 0)  this.ArrangePeople();											// Every 15 secs, arrange people
			if (this.retryWS) {																		// If reconnectng to websocket
				if (isLocal) this.ws=new WebSocket('ws://'+window.location.host+':8080');			// Open insecure websocket											
				else		 this.ws=new WebSocket('wss://'+window.location.host+':8080');			// Secure											
				this.ws.onmessage=(e)=>{ this.SocketIn(e); };										// ON INCOMING MESSAGE
				this.ws.onclose=()=>   { this.retryWS=true; console.log('disconnected'); };			// ON CLOSE
				this.ws.onopen=()=>    { console.log('re-connected'); };							// ON OPEN  
				this.retryWS=false;																	// Not retrying	
				}
			if (this.videoWin && (this.videoWin.closed !== false)) { this.videoWin=null; }			// Check if window was closed and set var
			},1000)
		}

	Draw()																						// REDRAW
    {
        this.bx=$("body").width(),      this.by=$("body").height();                                 // Body size
		isSmall=(this.bx < 700);																	// Set mobile flag
     	 $("#co-main").width(this.bx);   $("#co-main").height(this.by);                              // Set div
	    this.ArrangePeople();                                                                       // Arrange people               
		let x=Math.max(0,Math.min(this.bx-avSize,$("#co-AvMe").offset().left));						// Cap me x to screen
		let y=Math.max(0,Math.min(this.by-avSize*2,$("#co-AvMe").offset().top));					// Y
		$("#co-info").css({ "grid-row": isSmall ? "3/4" : "2/3" });									// Set grid responsively
		$("#co-hall").css({ "grid-row": isSmall ? "2/3" : "1/3", "grid-column":isSmall ? "1/2": "2/3" });			
		$("#co-AvMe").offset({left:x,top:y });														// Move icon there
	}

	JoinMeeting(id)																				// JOIN MEETING
	{
		id=this.pIndex[id];																			// Turn id into inde		
		this.myId=id;																				// My id
		this.myEmail=this.people[id].email;															// Get my email
		this.DrawVenue();																			// Draw venue		
		this.DrawPeople();																			// Draw people avatars
		this.Draw();																				// Draw screen
		this.GoToCenter();																			// Go to center of room
		$("#splashDiv").fadeOut();																	// Fade out splash
		$("#co-top").animate({opacity:1},1000,()=>{ app.ArrangePeople(); $("#splashDiv").html("") }); // Fade in main, the arrange people
		if (app.reg) delete app.reg;																// Delete reg if there
	}

	SocketIn(event)																				// A WEBSOCKET MESSAGE
	{
		let id,meeting="";
		let msg=event.data;																			// Get message
		let v=event.data.split("|");																// Split message
		if (v[1]) meeting=v[1].split("~")[0];														// Get meeting id
		if (v[0] == "C") {																			// CHAT
			if (meeting != this.meetingId)	return;													// Not this meeting
			id=this.pIndex[v[2]];																	// Get index from id			
			this.chat.chats.push({ dir:0, id:id, msg:v[3] });										// Archive
			if (($("#co-textDiv").length) && (this.chat.curChat == id)) {							// If chat window is open with same person
				$("#co-textDiv").append("<div class='co-textR'>"+v[3]+"</div><br>");				// Add message
				$("#co-textDiv").scrollTop(10000);													// Scroll to bottom
				}
			else{																					// Send to message queue
				this.chat.queue.push({ id:id, msg:v[3] });											// Add to queue
				if ($("#co-qv-0").length) this.chat.ShowQueue();									// Show the message queue, if open	
				$("#co-queue").text(app.chat.queue.length); 										// Reset queue dot length
				$("#co-queue").show();																// Show dot
				let o=this.people[id];																// Point at person
				let str=`<div onclick="app.chat.Chat('${id}')"><b>New message from</b>
				<p><img style="width:40px;height:40px;border-radius:50px" src="${o.pic}"></p>
				<b>${o.firstName} ${o.lastName}</b><br>${o.org}<p><hr></p>
				<div style="color:#0000ff">${v[3]}</div><br>`;		
				Popup(str,5000);																	// Show popup
				}
			Sound("ding");																			// Ring the bell
			}
		else if (v[0] == "L")	{																	// MOVE
			if (meeting != this.meetingId)	return;													// Not this meeting
			id=this.pIndex[v[1]];																	// Get index from id			
			let x=v[3]/100*(this.bx-12);															// Calc x from %
			let y=v[4]/100*(this.by-12);															// Y
			x=Math.max($("#co-iframe").width()+24,Math.min(this.bx-avSize,x));						// Cap x to hall
			y=Math.max(0,Math.min(this.by-avSize*2,y));												// Y
			this.people[id].f=0; this.people[id].x=x; this.people[id].y=y; this.people[id].stats=v[5]; // Update people object
			$("#co-Av-"+id).animate({ left:x+"px", top:y+"px"});									// Animate icon there
			if (v[5] == "Q")							$("#co-Av-"+id).css("display","none");		// Hide this person if quiet
			else if ($("#co-top").css("opacity") > 0)	$("#co-Av-"+id).css("display","block");		// Show them, if initted
			if (v[5].match(/^[B|R]/))	this.ArrangePeople();										// Arrange people at bar and rooms
			$("#co-Av-"+this.myId).css("display","none");											// Always hide my own avatar
			$("#co-At-"+id).css("display",v[5].match(/^[B|R1|R2|R3]/) ? "none" : "block");			// Hide or show name tag
			}
		else if (v[0] == "P") {																		// Add/update people
			this.AddPeople(JSON.parse(v[1]));														// Set data								
			if (v[2] == "U")	app.DrawPeople();													// Redraw on update
			}
		else if (v[0] == "WP") {																	// Update people
			this.AddPeople(JSON.parse(v[2]));														// Set data								
			app.DrawPeople();																		// Redraw 
			}
		else if (v[0] == "S") {																		// Add/update schedule
			this.AddSchedule(JSON.parse(v[1]));														// Set data
			this.DrawVenue();																		// Draw venue
			}
		else if (v[0] == "WS") {																	// pdate schedule
			this.AddSchedule(JSON.parse(v[2]));														// Set data
			this.DrawVenue();																		// Draw venue
			}
		else if (v[0] == "MP") {																	// Update person
			let d=JSON.parse(v[2]);																	// Objectify
			let i=this.pIndex[d.id];																// Get index
			if (d) this.people[i]=d;																// Set data								
			}
		else if (v[0] == "B") {																		// BROADCAST
			if (v[2].charAt() == "*") {																// If TTS
				v[2]=v[2].substr(1);																// Remove star
				this.chat.Speak(v[2]);																// Say it
				}
			Popup(`<b style="color:#990000">A message<br>from your meeting host</b><hr><br>${v[2]}<br><br>`,6000);	// Alert them
			Sound("ding");																			// Ding
			}
		else if (v[0].charAt(0) == "K") 	this[v[0]]=v[1];										// Set ks
		else if (v[0] == "BT") {																	// NEW TOPIC
			Sound("ding");																			// Ding
			this.curItem=v[2];																		// Set item
			this.ArrangePeople();																	// Show it
			}
		}
	
	OnMeMove(x, y, targetId)																	// REACT TO MOVING ME AVATAR
	{
		let i,link;
		targetId=targetId.replace(/co-AvMe/,"");													// It's just me
		if (targetId.match(/co-coffee/)) {															// IN COFFEE BAR
			this.status="B0";																		// Set status     
			let str="japp.htm?/~"+this.meetingId+"~coffeebar-0-0";									// Assume Jitsi
 			if ((this.status == "B0-0") && this.coffeebarLink) 	str=this.coffeebarLink;				// Use spec'd link for main bar
			this.sced.ShowLink(str); 																// Go to the coffee bar 
			}
		else if (targetId.match(/co-room-/)) {														// IN A ROOM
			i=targetId.substr(8);																	// Get id
			this.status="R"+i;																		// Set status     
			this.SetLink("japp.htm?/~"+this.meetingId+"~room"+i+"~"+this.meetingId); 				// Go to room
//			for (i=0;i<this.people.length;++i) { this.people[i].stats="R0"; $("#co-Av-"+i).show() };													
			}
		else{																						// General click
			this.CloseAll();																		// Close all open dialogs
			this.status="A";																		// In active mode
			}
		x=Math.max(0,Math.min(this.bx,x-avSize/2));													// Cap x to screen
		y=Math.max(0,Math.min(this.by,y-avSize/2));													// Y
		this.ReportLocation(x/(this.bx-12),y/(this.by-12),this.status);								// Report my move
		this.chat.curChat=-1;																		// Not chatting with anyone
	}

	GoToCenter()																				// MOVE TO CENTER HALL OR SPECIFIC SPOY
	{
		let x=(Math.random()*10+80)/100;															// Hover X in center
		let y=(Math.random()*10+75)/100;															// Y
		app.ReportLocation(x,y);																	// Report location
		$("#co-AvMe").animate({ left:this.bx*x, top:this.by*y });									// Animate me there	
	}

	ArrangePeople()                                                                             // ARRANGE COFFEE BAR / ROOM MEMBERS
    {
		let h,i,j,o,x2,inc,bar=[];
     	let	x=$("#co-coffee").offset().left;                                    					// left side of bar
       	let w=$("#co-coffee").width()-avSize;                                  						// Width of space
       	let y=this.by-$("#co-coffee").height()-avSize+2;                       						// On top of bar area
		
	   	$("[id^=co-adj-]").css("background-color","");												// Reset all agendas
		$("#co-adj-"+this.curItem).css("background-color","#d8c4ae");								// Hilite current one
		$("#topicDiv").html(`<b>Current topic:</b><br>${$("#co-adj-"+this.curItem).text()}`);		// Table topic

		for (i=0;i<this.people.length;++i) {														// For each person
			o=this.people[i];																		// Point at them
			$("#co-At-"+i).html(`${o.firstName}<br>${o.lastName}`);									// Set label
			$("#co-Ap-"+i).prop("src",o.pic ? o.pic : "img/avyou.png");								// Set image
			$("#co-Av-").animate({ left:this.bx*o.x, top:this.by*o.y });							// Animate here	
			if ((o.stats) == "B0") 	bar.push(i); 													// In a bar		
			inc=avSize+2;                                                                          	// Spacing between barmates
			}
		if (bar.length > 1) inc=Math.min(inc,w/(bar.length-1));                                 	// Squeeze them in?
		for (i=0;i<bar.length;++i) {                                                            	// For each barmate
			if (bar[i] == this.myId) $("#co-AvMe").animate({ left:x, top:y},0)                  	// Move me
			else  					 $("#co-Av-"+bar[i]).animate({ left:x, top:y},0);           	// Move them
			$("#co-At-"+bar[i]).css("display","none");                                         		// Hide me tag
			if (j)  y+=inc;    else x+=inc;                                                  		// Advance
			}
  
		let n,ox,y2,rms=[ [],[],[],[] ];
		for (i=0;i<this.people.length;++i) {														// For each person
			o=this.people[i];																		// Point at stats
			if (o.stats && (o.stats.charAt(0) == "R"))  rms[o.stats.substr(1)].push(i);				// If in a room, add person to it
			}

		if (rms[0].length) {																		// ARRANGE MAIN TABLE
			let h=-1;
			for (i=0;i<rms[0].length;++i) 															// For person in main room
				if (this.people[rms[0][i]].role.match(/host/i))	h=rms[0][i];						// Get host
			let d=360/rms[0].length;																// Angle spacing
			if (h < 0)  d=360/(rms[0].length+1);													// Leave room for host if absent
			let cx=$("#co-table").offset().left+$("#co-table").width()/2;							// Table center X
			let cy=$("#co-table").offset().top+$("#co-table").height()/2;							// Y
			let rad=$("#co-table").width()/2+avSize+16;
			j=-90+d;
			
			for (i=0;i<rms[0].length;++i) {															// For person in main room 
				x=Math.cos(j*0.01745329252)*rad+cx-(avSize/2);										// Get member x
				y=Math.sin(j*0.01745329252)*rad+cy-(avSize/2);										// y
				if (this.people[rms[0][i]].role.match(/host/i))	continue; 							// Skip host
				if (rms[0][i] == this.myId) $("#co-AvMe").animate({ left:x, top:y},0); 				// If me
				else 					  	$("#co-Av-"+rms[0][i]).animate({ left:x, top:y},0);		// Other person												
				$("#co-At-"+rms[0][i]).css("display", "block");										// Show name tag
				j+=d;																				// Next spot
				}
				if (h > -1) {																			// If host is at the table
				x=Math.cos(-90*0.01745329252)*rad+cx-(avSize/2);									// Get host x
				y=Math.sin(-90*0.01745329252)*rad+cy-(avSize/2);									// y
				if (h == this.myId) $("#co-AvMe").animate({ left:x, top:y},0); 						// If host is me
				else 				$("#co-Av-"+rms[0][h]).animate({ left:x, top:y},0);				// Other person												
				}
			}

		for (j=1;j<rms.length;++j) {																// For each room
			ox=$("#co-room-"+j).offset().left+4;													// Left side
			x=ox;																					// Start pos
			x2=x+$("#co-room-"+j).width()-avSize-8;													// Width of space
			w=avSize+2;																				// Full size spacing
			n=rms[j].length;																		// Number of people
			y2=$("#co-room-"+j).offset().top-24;													// Top
			y=$("#co-room-"+j).offset().top+$("#co-room-"+j).height()-avSize;						// Bottom
			w=Math.min(Math.sqrt(((x2-ox)*(y-y2)/n)),avSize+2);										// Set avatar spacing
			if (this.people[this.myId].stats == "R"+j)												// If I'm in this room		
				$("#co-AvMe").animate({ left:x, top:y},0),x+=w; 									// Move me in
			for (i=0;i<n;++i) {																		// For person in room
				if (rms[j][i] == this.myId)	continue;												// Skip me
				$("#co-Av-"+rms[j][i]).animate({ left:x, top:y},0);									// Move there
				$("#co-At-"+rms[j][i]).css("display","none");										// Hide me tag
				x+=w;																				// Advance
				if (x > x2)	{ x=ox;	 y-=w; }														// Next row
				if (y < y2)	break;																	// Quit if too many
				}
			}
		$("#co-Av-"+this.myId).css("display","none");												// Always hide my own avatar
	}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// VENUE
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	ReportLocation(x, y, status="A")															// REPORT LOCATION TO SERVER
	{
		x=Math.min(Math.max(0,(x*100).toFixed(2)),100);											// Scale x 0-100
		y=Math.min(Math.max(0,(y*100).toFixed(2)),100);											// y
		if (app.ws)	app.ws.send(`L|${app.people[app.myId].id}|0|${x}|${y}|${status}`); // Send Location message
	}
	
 	CloseAll(mask=0)                                                                        	// CLOSE ALL OPEN DIALOGS
    {
		$("#co-chat").remove();                                                                     // Close chat if open
        $("#co-card").remove();     																// Card                                                                
		let src=$("#co-iframeFrame").prop("src");													// Get iframe link		
		this.SetLink("");																			// Close video window
		if (mask&2 && this.videoWin)  		 this.videoWin.close();									// Close open video window
		else if (this.videoWin)		  		 this.videoWin.focus();									// Put it on front
    }

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// DATA
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	AddPeople(people)																				// ADD PEOPLE TO MEETING
	{
		let i,o;
		people.sort((a,b)=>{ return (a.id.split("~")[1]-0 > b.id.split("~")[1]-0) ? 1 : -1 });			// Sort by numeric id
		this.people=people;																				// Set data
		for (i=0;i<people.length;++i) {																	// For each person
			let id=people[i].id.split("~")[1];															// Split id out
			o=this.people[i];																			// Point at them
			if (o.email == this.myEmail) this.myId=i;													// Set myid
			this.pIndex[people[i].id]=i;																// Save index by full id
			}
	}

	AddSchedule(sced)																				// ADD SCHEDULE
	{
		this.sced.schedule=sced;																		// Set data
		this.sced.schedule.sort((a,b)=>{ return (a.start-0 > b.start-0) ? 1 : -1 });					// Sort by start
	}

	DrawPeople(num)																					// ADD PEOPLE TO MEETING
	{
		let i,o,str="";
		$("[id^=co-Av-]").remove();		$("#co-AvMe").remove();											// Remove existing people
		for (i=0;i<this.people.length;++i) {															// For each person
			o=this.people[i];																			// Point at them
			o.x=Math.max(0,Math.min(o.x,95));															// Cap x to screen
			o.y=Math.max(0,Math.min(o.y,95));															// Cap x to screen
			if (!this.people[i].pic)	this.people[i].pic="img/avyou.png";								// Use generic pic
			str+=`<div class="co-avatar" id="co-Av-${i}" style="top:${o.y}%;left:${o.x}%;
			display:${(o.stats == "Q") ? "none" : "block"}"> 
			<div style="width:${avSize}px;height:${avSize}px;overflow:hidden;border-radius:64px;display:inline-block">
			<img id="co-Ap-${i}" src="${o.pic}" style="width:${avSize}px;min-height:${avSize}px"></div>
			<div id="co-At-${i}">${o.firstName}<br>${o.lastName}</div></div>`;							// Add person
			}
		str+=`<div class="co-me" id="co-AvMe" style="width:${avSize}px;height:${avSize}px">
		<img src="img/avme.png" width="100%">
		<div id="co-queue" class="co-qNum" style="margin:-15px 0 0 13px"></div></div>`;					// Add me
		$("body").append(str);																			// Add to body
		$("#co-AvMe").draggable({ containment:"#co-hall" });											// I'm draggable
		$("[id^=co-Av-]").on("click", (e)=>{ this.chat.ShowCard(e.currentTarget.id.substr(6)); }); 		// ON PERSON CLICK
		$("#co-AvMe").on("click", (e)=>{ this.chat.ShowQueue();	}); 									// ON ME CLICK
	}
	
	DrawVenue()																						// DRAW VENUE
	{
		this.bx=$("body").width(),		this.by=$("body").height();										// Body size
		let str=`<div style="display:grid;grid-gap:12px">
				<div id="co-iframe" class="co-iframe" style="grid-column:1/2;grid-row:1/2">
					<div id="co-vMsg" style="margin-top:20vh;text-align:center;width:100%;color:#ddd"><br>Video will appear here<br>when you drag your icon to<br>the table, a room, or the coffeebar</div>
					<iframe id="co-iframeFrame" style="width:100%;height:100%;border-radius:4px;"
					src="" allow=camera;microphone;autoplay frameborder="0" allowfullscreen>
					</iframe>
				</div>
				<div id="co-info" class="co-info" style="grid-column:1/2;grid-row:2/3">
					<div id="agendaDiv" class="co-docs">
						<div class="co-title">Todays's agenda</div>
						<div id="agendaItems" class="co-items"></div>
					</div>
					<div id="docsDiv" class="co-docs" style="margin-left:12px">
						<div class="co-title">Resources</div>
						<div  id="docItems" class="co-items"></div>
					</div>
				</div>
				<div id="co-hall" class="co-hall" style="grid-column:2/3;grid-row:1/3">
					<div id="co-room-0" class="co-mroom">
						<div id="co-table" class="co-table">
							<img src="img/wlogo.png" style="width:33%;margin-top:8vw">
							<div id="topicDiv" class="co-topic">
						</div>
					</div>
				<div style="margin-top:12px">
					<div id="co-room-1" class="co-breakout">Room A</div>
					<div id="co-room-2" class="co-breakout">Room B</div>
					<div id="co-room-3" class="co-breakout">Room C</div>
				</div>
				<img id="co-coffee" src="img/coffeebar.png" style="width:160px;margin-left:-80px;position:absolute;top:calc(100vh - 80px);">
				${this.people[this.myId].role.match(/host/i) ? "<img id='co-gear' src='img/gear.png' style='cursor:pointer;width:25px;position:absolute;top:calc(100vh - 50px);left:calc(100vw - 50px)'>" : ""}
			</div>
		</div>`;
		
		$("#co-main").html(str.replace(/\t|\n|\r/g,""));												// Add venue
		$("#co-hall").droppable({	drop:(e)=>{ this.OnMeMove(e.pageX,e.pageY,e.target.id); }});   		// ON DROP ON ROOM
		$("[id^=co-room-]").droppable({	drop:(e)=>{ this.OnMeMove(e.pageX,e.pageY,e.target.id) }}); 	// ON DROP ON ROOM
		$("#co-coffee").droppable({	drop:(e)=>{ this.OnMeMove(e.pageX,e.pageY,e.target.id); }});   		// ON DROP ON COFFEE BAR
		$("#co-gear").on("click",()=>{ this.DrawDash(); });												// ON DASHBOARD	CLICK
		this.SetAgenda();																				// Set agenda
		this.SetDocs();																					// Set docs
	}

	SetAgenda()																						// DRAW AGENDA ITEMS
	{
		let i,k=0,o,str="<ul style='list-style-type:none;padding:24px;margin:0'>";
		for (i=0;i<this.sced.schedule.length;++i) {														// For each item
			o=this.sced.schedule[i];																	// Point at it
			if (o.day == 1) {																			// An agenda item
				str+=`<li id="co-adj-${k++}" style="margin-bottom:2px;border-radius:48px;cursor:pointer;padding-bottom:2px">`;	// Item head
				if (o.desc.charAt(0) == "*")	str+="<b>"+o.desc.substr(1)+"</b>";						// A bold item
				else							str+=o.desc;											// Regular item
				str+="</li>";																			// End item
				}	
			}
		str+="</ul>";																					// End list
		$("#agendaItems").html(str.replace(/\t|\n|\r/g,""));											// Add agenda
		$("[id^=co-adj-]").on("click",(e)=>{															// ON AGENDA CLICK
			app.ws.send(`BT|${app.meetingId}|${e.currentTarget.id.substr(7)}`);							// Broadcast item change
			});
	}

	SetDocs()																						// SET DOCS
	{
		let i,p,o;
		let str="<ul style='list-style-type:none;padding:24px;margin:0'>";								// List 							
		for (i=0;i<this.sced.schedule.length;++i) {														// For each item
			o=this.sced.schedule[i];																	// Point at it
			if (o.day == 2) 																			// A doc
				str+=`<li id="co-doc-${i}" style="margin-bottom:4px;cursor:pointer">${o.desc}</li>`;	// Add doc title/link
			}
		str+="</ul>";																					// End list
		$("#docItems").html(str.replace(/\t|\n|\r/g,""));												// Add agenda
		$("[id^=co-doc-]").on("click",(e)=>{															// ON DOC CLICK
			let id=e.currentTarget.id.substr(7);														// Get id
			let o=this.sced.schedule[id];																// Point at it
			if (o.link.charAt(0) == "=") {																// Show a web page
				$("#co-docFrame").remove();																// Kill existing
				let str=`<div id="co-docFrame" class="co-card"' style="margin:0;padding:16px;box-shadow:none;background-color:#eee;
				left:${$("#co-hall").offset().left}px;top:${$("#co-hall").offset().top}px;max-height:${$("#co-hall").height()-34}px;overflow:auto;
				width:${$("#co-hall").width()-32}px;height:100vh">
				<img id="co-igc" style="float:right;cursor:pointer" src="img/closedot.png">
				<b>${o.desc}<br><br></b>
				<iframe id="co-iframeFrame" style="width:100%;height:${$("#co-hall").height()-78}px" src="${o.link.substr(1)}" 
				allow=camera;microphone;autoplay frameborder="0" allowfullscreen></iframe></div>`;
				$("body").append(str.replace(/\t|\n|\r/g,""));											// Draw
				$("#co-igc").on("click", ()=>{ $("#co-docFrame").remove(); });							// ON CLOSE BUT
				}
			else if (o.link.charAt(0) == "!") 																// Show a web page
				window.open(o.link.substr(1),"_blank","width=99%");										// Open in new window
				else	
				window.open(o.link,"_blank");															// Open in new tab
			});



	}
//				str+=`<a href="${o.link}" target="_blank">`;											// Add link
	
	SetLink(link)																					// SET IFRAME LINK
	{
		$("#co-vMsg").css("display",link ? "none" : "block");											// Hide show message
		if (link.match(/zoom/i)) {																		// If Zoom
			app.curZoom=link;																			// Save link
			let myWin=window.open(link,"_blank","scrollbars=no,toolbar=no,status=no,menubar=no");		// Open zoom link
			setTimeout(function(){ myWin.close(); },10000);												// Close after 10 secs
			}
		else{																							// Use iframe
			if (link.match(/zapp/i)) {																	// An embedded zoom link
				let str="";
				if (isMobile)	str="zoomus";															// Use mobile header
				else if (navigator.userAgent.indexOf('Safari') != -1 && navigator.userAgent.indexOf('Chrome') == -1) str="zoommtg";
				if (str) {
					str+="://zoom.us/join?confno="+link.split("?")[1];									// Make full url
					this.SetLink(str);																	// Open with native app							
					return;																				// Quit
					}
			}
		if (link.match(/zapp/i)) link=goPath+link+"&"+app.KZ;											// If zoom app, add k
		if (link.match(/japp/i)) link=goPath+link+"&"+app.people[app.myId].firstName+"-"+app.people[app.myId].lastName+"&"+app.people[app.myId].role+"&!server=AWS";
		$("#co-iframeFrame").prop("src",link);															// Set iframe link
		}
	}

	DrawDash()																						// DRAW HOST DASHBOARD
	{
		let i,o;
		$("#co-dash").remove();
		let str=`<div id="co-dash" class="co-dash">
			<span style="font-size:24px"><b>MEETING SETUP</b></span>
			<img style="float:right;cursor:pointer" src="img/closedot.png" onclick="$('#co-dash').remove()"><br><br>
			<div style="display:inline-block; width:100%">
				<div class="co-dashTable"><span style="font-size:18px"><b>People</b></span>
					<br><br><textarea id="co-dash-people" class="co-dashText"></textarea>
					<br><br><div style="width:100%;max-width:400px;text-align:left;display:inline-block">
						Type or paste the email address of each person you want in the meeting on a separate line. 
						The first time they attend, they will fill out their name tag information. 
						You do not need to add your own email.
						</div>
					</div>
				<div class="co-dashTable"><span style="font-size:18px"><b>Agenda</b></span>
					<br><br><textarea id="co-dash-agenda" class="co-dashText"></textarea>
					<br><br><div style="width:100%;max-width:400px;text-align:left;display:inline-block">
						Type or paste the agenda items for the meeting, each on it's own line. 
						If you want the item to appear<b> bold</b> 
						start the item with a * (i.e. <i>*New business</i>).
					</div>
				</div>
				<div class="co-dashTable"><span style="font-size:18px"><b>Resources</b></span>
					<br><br><textarea id="co-dash-res" class="co-dashText"></textarea>
					<br><br><div style="width:100%;max-width:400px;text-align:left;display:inline-block">
						Type or paste the resources for the meeting. Each resource uses two lines.
						The first of the pair is the title that is displayed, 
						and the second is the full url including <i>http</i> or <i>https</i>. 
						If you want the link to appear within the layout, preface it with an equals = sign. 
						In a new page instead of a new tab, preface the url with an exclamation ! mark. 
						
						</div>
					</div>
				</div>
	
			<p><div class="co-bsg" style="float:right;margin-right:16px;font-size:24px;background-color:#a2733f;padding:0 12px 4px 12px;" 
			id="co-dAdd">Save to meeting</div></p>
			<input type="text" class="co-is" id="co-dash-btext" placeholder="Type message to broadcast here"
			style="text-align:center;width:300px;margin-left:200px">
			&nbsp;&nbsp;Send voice too? <input type="checkbox" id="co-dash-btts"> 
		</div>`;
		$("body").append(str.replace(/\t|\n|\r/g,""));
		
		$("#co-dash-btext").on("change", ()=>{														// ON BROADCAST
			let s=$("#co-dash-btext").val();														// Get text
			if ($("#co-dash-btts").prop("checked"))	s="*"+s;										// Add TTS prefix
			$("#co-dash-btext").val("");															// Clear
			app.ws.send(`B|${app.meetingId}|${app.people[app.myId].id}|`+s);						// Broadcast
			});

		str="";																						// Clear
		for (i=0;i<this.people.length;++i) 	 str+=this.people[i].email+"\n";						// Add emails
		$("#co-dash-people").val(str);																// Fill textarea
		str="";																						// Clear
		for (i=0;i<this.sced.schedule.length;++i) 													// For each item
			if (this.sced.schedule[i].day == 1)														// If an agenda item
				str+=this.sced.schedule[i].desc+"\n";												// Add it														
		$("#co-dash-agenda").val(str);																// Fill textarea
		str="";																						// Clear
		for (i=0;i<this.sced.schedule.length;++i) 													// For each item
			if (this.sced.schedule[i].day == 2)														// If a resource item
				str+=this.sced.schedule[i].desc+"\n"+this.sced.schedule[i].link+"\n";				// Add it														
		$("#co-dash-res").val(str);																	// Fill textarea
	
		$("#co-dAdd").on("click", ()=>{																// ON SAVE 
			let d=[];																				
			let v=$("#co-dash-agenda").val().replace(/\r/g,"").split("\n");							// Split agenda into lines
			let n=v.length;																			// Save length
			for (i=0;i<v.length;++i) 																// For each agenda item
				if (v[i].length)																	// If something there
					d.push({ day:1, start:i, desc:v[i], meeting:this.meetingId, id:this.meetingId+"~"+i }); // Add to data
			v=$("#co-dash-res").val().replace(/\r/g,"").split("\n");								// Split resources into lines
			for (i=0;i<v.length;i+=2)																// For each
				if (v[i].length && v[i+1].length )													// If something there
					d.push({ day:2, start:i/2, desc:v[i], link:v[i+1], meeting:this.meetingId, id:this.meetingId+"~"+(n+i/2) }); // Add to data
			this.AddSchedule(d);																	// Add data to schedule
			app.ws.send(`WS|${this.meetingId}|${JSON.stringify(d)}`);								// Write to DB table
			d=[];
			v=$("#co-dash-people").val().replace(/\r/g,"").split("\n");								// Split people into lines
			v.push(this.myEmail);																	// Add me
			for (i=0;i<this.people.length;++i)														// For each person
				if (v.includes(this.people[i].email)) 												// Person already in
					d.push(this.people[i]);															// Add them	
				for (i=0;i<v.length;++i) {															// For each person in list
					if (!v[i]) continue;															// Skip if blank
					if (!d.some((val,index)=>{return (val.email.toLowerCase() == v[i].toLowerCase())}))	// If a new person														
						d.push({ email:v[i], stats:"Q", f:0, role:"",meeting:this.meetingId });		// Add them	
					}
			for (i=0;i<d.length;++i)	d[i].id=this.meetingId+"~"+i								// For each person, set id
			this.AddPeople(d);																		// Set people data								
			
			
			app.ws.send(`WP|${this.meetingId}|${JSON.stringify(d)}`);								// Write to DB table
			this.DrawVenue();																		// Redraw
			$("#co-dash").remove();																	// Kill dialog
			Sound("ding");																			// Ding
			});
	}

} // APP CLASS CLOSURE

/*
*Old business
New board members
Membership drive
Holiday party
*New Business
Treasurer's report
Unison Day
New mission statement
*/

// HELPERS //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////	

	function trace(msg, p1, p2, p3, p4)										// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function GetTextBox(title, content, def, callback, x, y)										// GET TEXT LINE BOX
	{
		$("#confirmBoxDiv").remove();																	// Remove 
		$("body").append("<div class='co-confirm' id='confirmBoxDiv' style='text-align:center'></div>");	// Add box								
		if (x != undefined)		$("#confirmBoxDiv").css({ left:x+"px", top:y+"px" });					// Position if set
		let str="<img src='img/logo.png' width='64'/><br>";												// Logo					
		str+="<p style='font-size:14px; color:#666'><b>"+title+"</b></p>";
		str+="<p>"+content+"<p>";
		str+="<p><input class='co-is' style='width:95%' type='text' id='co-revText' value='"+def+"'>";
		str+="<img id='co-talkBut'src='img/talkbut.png' style='vertical-align:-7px;margin-left:-20px;cursor:pointer'></p>";
		str+="<div id='dialogOK' class='co-bs' style='background-color:#009900'>OK</div>";
		str+="<div id='dialogCancel' class='co-bs' style='margin-left:8px;background-color:#999'>Cancel</div></div>";
		$("#confirmBoxDiv").html(str);																	// Add to div
		$("#co-revText").focus();																		// Focus on button
		$("#co-talkBut").on("click", ()=>{app.chat.Listen()});											// Start STT
		$("#co-revText").on("change", function() {	callback($("#co-revText").val()); $("#confirmBoxDiv").remove(); });	// ONE ENTER
		$("#dialogOK").on("click", function() {	callback($("#co-revText").val()); $("#confirmBoxDiv").remove(); });	// ON OK 
		$("#dialogCancel").on("click", function() {	$("#confirmBoxDiv").remove(); });								// ON CANCEL
		}

	function Sound(sound, mute)																		// PLAY SOUND
	{
		let snd=new Audio();																			// Init audio object
		if (sound.match(/\.mp3/i))		snd=new Audio(sound)											// If an MP3 file
		else							snd=new Audio("img/"+sound+".mp3");								// Use built in mp3
		if (!mute)	{																					// If not initing or muting	
			snd.volume=100/100;																			// Set volume
			snd.play();																					// Play it
			}
	}

	function Popup(msg, time, div)																	// TIMED POPUP
	{
		let str="";
		$("#co-popupDiv").remove();																		// Kill old one, if any
		if (document.fullscreenElement)	document.exitFullscreen();										// Force non-full screen 
		str+="<div id='co-popupDiv' class='co-popup'>"; 												// Add div
		if (time == -1) {																				// If has close but
			time=100000;																				// Increase time
			str+="<img id='pu-close' src='img/closedot.gif' style='float:right;cursor:pointer'>";		// Add close button
			}
		str+=msg+"</div>"; 																				// Add div
		$(div ? "#"+div : "body").append(str);															// Add popup to div or body
		$("#pu-close").click(function() { $("#co-popupDiv").remove(); });								// Remove on click of close but
		$("#co-popupDiv").fadeIn(500).delay(time ? time : 2000).fadeOut(500)							// Animate in and out		
	}

	function trace2(msg, p1, p2, p3, p4)															// MOBILE CONSOLE 
	{
		trace(msg);
		alert(msg)
		$("#co-Rm-2").html(">"+msg+"<")
	}

</script>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-179601831-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-179601831-1');
</script>

</body>
</html>
