
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=.66, shrink-to-fit=yes">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
	<script src="lib/jquery.ui.touch-punch.min.js"></script>
	<script src="chat.js"></script>
	<script src="schedule.js"></script>
	<script src="venue.js"></script>
	<script src="register.js"></script>
	<link REL="SHORTCUT ICON" HREF="img/favicon.ico">
	<title>èt•al Meeting</title>
</head>
<style>
	body 		{ 	font-family:Segoe UI,Verdana,Geneva,sans-serif; font-size:10px; padding:0px; box-sizing:content-box; margin:0;
					/*background-image:url("img/clouds.jpg"); background-size:cover;*/ } 
	.co-splash 	{ 	position:absolute; width:100%; top:0; left:0; text-align:center; margin-top:15%; display:none; font-size:12px; }
	.co-top		{	opacity:0; overflow:hidden; height:100vh; z-index:0;}
	.co-venue 	{	display:grid; text-align:center; height:100%; color:#fff; user-select:none; -webkit-user-select:none; -ms-user-select:none; }
	.co-room 	{	background-repeat:repeat; border-radius:0px; font-size:18px; color:#fff; overflow:hidden; }
	.co-roomHdr	{	width:calc(100% - 24px); text-align:center; color:#fff; padding:12px; font-size:16px; pointer-events:none; }
	.co-roomTitle {	font-size:18px; color:#fff; pointer-events:none; margin-top:12px; }
 	.co-avatar 	{	position:absolute; cursor:pointer; left:50%; top:50%; font-size:12px; text-align:center; user-select:none;
	 				line-height:1.2em; -webkit-user-select:none; }
	.co-me 		{	position:absolute; cursor:url(img/move.cur),auto; left:50%; top:50%; border-radius:64px; user-select:none; -webkit-user-select:none; }
	.co-qNum 	{	position:relative;color:#fff; text-align:center; font-size:9px; border-radius:16px; background-color:#ff0000; 
					cursor:pointer; width:11px; height:11px; display:none;  }
	.co-card 	{	position:absolute; width:300px; height:150px; background-color:#fff; border-radius:4px;
					border:1px solid #666; padding:12px; text-align:center; font-size:14px; box-shadow:2px 2px 4px #999; }
	.co-sched 	{	position:absolute; background-color:#fff; padding:24px; text-align:center;	font-size:14px; 
					background-color:#e4e7ef; display:none; line-height:1.5; }
	.co-qlist 	{	position:absolute; width:274px; height:300px; background-color:#fff; border-radius:8px;
					border:1px solid #666; padding:12px; text-align:center; font-size:12px; box-shadow:2px 2px 4px #999; }
	.co-chat	{	position:absolute; width:230px; height:320px; background-color:#fff; border-radius:12px;
					border:1px solid #666; padding:12px; text-align:center; font-size:14px; box-shadow:2px 2px 4px #999; }
	.co-qlist 	{	position:absolute; width:274px; height:300px; background-color:#fff; border-radius:8px;
					border:1px solid #666; padding:12px; text-align:center; font-size:12px; box-shadow:2px 2px 4px #999; }
	.co-textR 	{	background-color:#dddddd; border-radius:16px; padding:4px 8px; width:-moz-fit-content; width:fit-content; max-width: 66%; margin:4px 6px; clear:both; float:left;  text-align:left; }
	.co-textS 	{	background-color:#0099ff; border-radius:16px; padding:4px 8px; width:-moz-fit-content; width:fit-content; max-width: 66%; margin:4px 6px; clear:both; float:right; text-align:right; color:#fff; }
	.co-people 	{	position:absolute; width:274px; height:50vh; background-color:#fff; border-radius:8px; z-index:2;
					border:1px solid #666; padding:12px; font-size:12px; box-shadow:3px 3px 6px #666; }
	.co-video	{	position:absolute; background-color:#fff; border-radius:4px; width:40%;
					border:1px solid #666; padding:8x; box-shadow:3px 3px 6px #666}
	.co-is 		{	border-radius:16px; padding:0 8px; width:250px; height: 24px; border:1px solid #999; font-size: 13px; }
	.co-logon 	{	border-radius:16px; padding:0 8px; width:200px; height: 24px; border:1px solid #999; font-size: 13px; text-align:center; }
	.co-confirm {	position: absolute;  width: 300px; padding: 16px; left: calc(50% - 300px); top: calc(50% - 150px); user-select: none;	
					border-radius: 8px; background-color: #fff; border: 1px solid #999; }
	.co-alert	{	position:absolute; color:#fff; font-size:12px; text-align:center; cursor:pointer; padding:4px; top:8px; }
	.co-is 		{	border-radius:16px; padding:0 8px; height: 24px; border:1px solid #999; font-size: 13px; }
	.co-bs 		{	display:inline-block; border-radius:16px; padding:0 8px; border:1px solid #eee; font-size: 13px; 
					cursor:pointer; z-index:2; padding-bottom:1px; color:#fff}
	.co-bsg		{	cursor: pointer; color:#fff; text-align: center; border-radius: 16px; display: inline-block; user-select: none;
					font-size: 13px; background-color: #999; padding: 2px 8px 2px 8px; }
	.co-popup 	{	position: absolute;  width:auto; padding:12px; left:40%; top:calc(50% - 50px); border-radius:8px; display: none;
					background-color:#fff; border:1px solid #999; font-size:14px; text-align:center; max-width:33%; min-width:20%; }
	.co-bulletin{	position:absolute;height:calc(100% - 96px); left:8; width:calc(100% - 34px); cursor:auto;
					overflow-x:hidden; overflow-y:auto; margin:0 8px; margin-top:-24px;color:#000;text-align:left; padding:8px; 
					font-size:13px;	background-color:#fff; border:1px solid #999; border-radius:6px; }
	.co-chalkboard{	width:calc(100% - 32px); padding:0 12px 12px 12px; font-size:16px; }

	.co-galleryItem{font-size:10px; color:#fff; }
	.co-resizer {	position:absolute; top:0; left:0; width:12px; height:100%; background-color:rgba(164,186,236); opacity:.5; 
					background-image:url(img/slider.png); background-repeat: no-repeat; background-position:center; }

	body ::-webkit-scrollbar { width: 9px; height:8px } 
	body ::-webkit-scrollbar-track { background: transparent; }
	body ::-webkit-scrollbar-thumb { border-radius:8px ;background:#a4baec }
	body ::-webkit-scrollbar-thumb:hover { background: #a4baec }

	@media only screen and (max-width:700px) {
		.co-top 				{ height:auto; overflow:auto }
		[id^=co-roomContent-]	{ min-height:50vh; max-height:50vh; }
		#co-roomContent-0 		{ min-height:75vh; }
		}

</style>
<body>

	<div id="co-top" class="co-top">
		<div id="co-main" style="width:100%;height:100%"></div>
	</div>
	<div id="splashDiv" class="co-splash">
		<img src="img/logo.png" alt="" style="width: 20%"><br><br>
		<p style="color:#000;font-size:14px"><em>A people centered virtual meeting tool</em></p>
		<br><br>
		<div id="co-splash2"><input type="text" id="co-logon" class="co-logon" placeholder="Type email to join"></div>
		<br><br>
		<b>For the best experience</b><br>Please use the Chrome or FoxFox browser<br>Use Safari on iPad
		<br><br>Click <a href="https://www.youtube.com/embed/_sBqnfkBNVI?rel=0&autoplay=1" target="_blank">here</a> to view a 90-second intro video
	</div>

<script>

	let app=null;																					// Holds app
	let	avSize=36;																					// Avatar size
	isSmall=false;																					// Mobile size flag
	if ((location.protocol != 'https:') && (window.location.host != "localhost")) location.href = 'https:' + window.location.href.substring(window.location.protocol.length); // FORCE HTTPS!
	$(window).on("resize orientationchange", ()=>{ if (app) app.Draw(); })                       	// ON WINDOW RESIZE/FLIP

	window.addEventListener("unload",  ()=>{ 													// ON CLOSE
		if (app.videoWin)	app.videoWin.close();													// Close video window if open
		app.ReportLocation(.5,.5, "Q", false); 														// Close me out from server
		});

	function HTML5eventHandler(e)																// ON HTML5 EVENT
	{
		if (e.data && (""+e.data).match(/VideoQuit/)) { $("#co-iframe").remove();  app.GoToCenter(); }	//  Quit video
	}

	$(document).ready(function() {								           							// ON PAGE LOADED
		if (window.addEventListener) 																// If supported this way
			window.addEventListener("message",HTML5eventHandler,false);								// Add event handler
		else																						// Use other method
			window.attachEvent("message",HTML5eventHandler);										// Add handler
		isMobile=navigator.userAgent.match(/(ipad|iphone|ipod|android)/i) ? true : false;			// Set mobile flag
		var url=window.location.search.substring(1);						   						// Get query string
		let meetingId=url ? url.split("&")[0] : "1";												// Set meeeting id
		app=new App(meetingId);                                      								// Alloc app
		$("#splashDiv").fadeIn();																	// Fade in splash
	
		if (url == "preview") {																		// PREVIEW MODE
			app.AddVenue(JSON.parse(localStorage.getItem('venue')));								// Add venue data
			app.AddSchedule(JSON.parse(localStorage.getItem('schedule')));							// Schedule
			app.DrawVenue();																		// Draw venue		
			app.DrawPeople();
			app.Draw();																				// Draw screen
			$("#splashDiv").fadeOut();																// Fade out splash
			$("#co-top").animate({opacity:1},1000);													// Fade in main, the arrange people
			}
		
		$("#co-logon").on("change",()=>{															// ON LOGON
			let i,pid=$("#co-logon").val();															// Get value
			for (i=0;i<app.people.length;++i) 														// For each person
				if (app.people[i].email.trim().toLowerCase() == pid.trim().toLowerCase())			// If a match
					break;																			// Quit looking
			if (i == app.people.length) {															// Email not found
				alert("This email was not found, please try again, or contact your meeting host"); 	// Alert
				return;																				// Quit																				
				}
			if (!app.people[i].firstName) {															// If no name
				let reg=new Register(i);															// Run registration code
				return;																				// Quit
				}
			app.JoinMeeting(app.people[i].id);														// Join meeting
			});
	
		$(window).on("keydown",function(e) {														// HANDLE KEYPRESS
			if ((e.which == 66) && e.altKey && e.ctrlKey) {											// Broadcast key (Ctrl+Alt+B)
				GetTextBox("Type or speak message","","",(s)=>{ app.ws.send(`B|${app.meetingId}|${app.people[app.myId].id}|`+s)});	// Broadcast
				}
			if ((e.which == 86) && e.altKey && e.ctrlKey) {	app.sced.VendorControl();	}			// Vendor control panel (Ctrl+Alt+V)
			if ((e.which == 87) && e.altKey && e.ctrlKey) {											// Time key (Ctrl+Alt+W)
				GetTextBox("Set time and day", "Type time/day to show. (Day is optional)","",(s)=>{	// Type time
					let v=s.split("/");																// Split time/day
					app.sced.mins=app.sced.TimeToMins(v[0],new Date().getTimezoneOffset());			// Set minutes
					if (v[1]) app.sced.day=v[1]-0;													// Set minutes
					app.DrawVenue();																// Draw venue
					app.ArrangePeople();	
					});
					}
			if ((e.which == 84) && e.altKey && e.ctrlKey) {											// Test key (Ctrl+Alt+T)
				let i,o,x=400,y=300;
				for (i=0;i<app.people.length;++i) {
					$("#co-Av-"+i).css("display","none")
					if (app.people[i].pic == "img/avyou.png") continue;
					if (app.people[i].stats.charAt(0) == "R") continue;
					$("#co-Av-"+i).css("display","block")
					if (!(i%9))	x=400,y+=80;
					x+=80;
					$("#co-Av-"+i).animate({ left:x+"px", top:y+"px"});
					$("#co-Av-"+i).draggable();
					}
				}
			});
	});	
 
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// APP
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class App  {																					

	constructor(meetingId)   																	// CONSTRUCTOR
	{
		app=this;																					// App global pointer
		this.meetingId=""+meetingId;																// Meeting id
		this.myEmail="";																			// My email
		this.myId=0;																				// My unique id
		this.curFloor=0;																			// Current floor
		this.venue=[];																				// Holds floors
		this.people=[{ stats:"Q"} ];																// Holds attendees
		this.pIndex=[];																				// Get people index from id
		this.status="";																				// My status
		this.infoDeskId=null;																		// Id of info desk person
		this.videoWin=null;																			// Video window
		this.vr="#co-Rm-0";																			// Assume hallway is video rooom for iframes
		this.retryWS=false;																			// Reconnecting to web socket
		this.KZ="";																					// Ks
		this.roomPortals=[];																		// Portals for this room
		this.hallPos={};																			// Hallway position
		this.curContent="";																			// Current floor's content
		this.coffeebarLink="";																		// Alternative link for main coffeebar
		this.privateMode=false;																		// Private mode
		this.speedMeeters=[];																		// Holds people in speed meeting

		if (window.location.search && window.location.search.match(/\&private/i)) this.privateMode=true;		// Start private mode
		if (window.location.host == "localhost") this.ws=new WebSocket('ws://'+window.location.host+':8080');	// Open insecure websocket											
		else									 this.ws=new WebSocket('wss://'+window.location.host+':8080');	// Secure											
		this.ws.onmessage=(e)=>{ this.SocketIn(e); };												// ON INCOMING MESSAGE
		this.ws.onclose=()=>   { this.retryWS=true; console.log('disconnected'); };					// ON CLOSE
		this.ws.onerror=(e)=> { 																	// ON ERROR
			console.log('error',e);
			let str=`<h1 style="color:#ff0000">There was a problem joining the meeting!</h1><p style="color:#000;font-size:14px;">
				Either the meeting server is down, or there may be a firewall blocking your access.<br><br>
				<b>Please contact you meeting's host for help.<b></p>`;
				$("#co-splash2").html(str); 
			};
		
		this.chat=new Chat();																		// Add chat class
		this.sced=new Schedule();																	// Add schedule class
		this.venu=new Venue();																		// Add venue class
	
		this.ws.onopen=()=> { 																		// ON OPEN
			if (this.meetingId != "preview") {														// If not previewing
				app.ws.send(`P|${app.meetingId}`);													// Request people data	
				app.ws.send(`V|${app.meetingId}`);													// Request venue data	
				}
			app.ws.send(`KZ|*`);																	// Request zk data	
			console.log('connected');  
			};				
		
		this.secs=0;	
		this.pollTimer= window.setInterval( ()=>{													// Init polling timer
			++this.secs;																			// Another second 
			if ((this.secs%15) == 0)  this.ArrangePeople();											// Every 15 secs, arrange people
			if ((this.secs%60) == 0) this.sced.CheckSchedule();										// On every minute, check the schedule
			if (this.retryWS) {																		// If reconnectng to websocket
				if (window.location.host == "localhost") this.ws=new WebSocket('ws://'+window.location.host+':8080');	// Open insecure websocket											
				else									 this.ws=new WebSocket('wss://'+window.location.host+':8080');	// Secure											
				this.ws.onmessage=(e)=>{ this.SocketIn(e); };										// ON INCOMING MESSAGE
				this.ws.onclose=()=>   { this.retryWS=true; console.log('disconnected'); };			// ON CLOSE
				this.ws.onopen=()=>    { console.log('re-connected'); };							// ON OPEN  
				this.retryWS=false;																	// Not retrying	
				}
			if (this.videoWin && (this.videoWin.closed !== false)) { this.videoWin=null; }			// Check if window was closed and set var
			},1000)
		}

	Draw()																						// REDRAW
    {
        this.bx=$("body").width(),      this.by=$("body").height();                                 // Body size
		let p=$("#co-Rm-0").offset();																// Get hallway position
		this.hallPos.x=p.left;																		// Set hallway left
		this.hallPos.y=p.top;																		// Top
		this.hallPos.w=$("#co-Rm-0").width();														// Width
		this.hallPos.h=$("#co-Rm-0").height();														// Height
		this.hallPos.x2=this.hallPos.x+this.hallPos.w;												// Right
		this.hallPos.y2=this.hallPos.y+this.hallPos.h;												// Bottom
		isSmall=(this.bx < 700);																	// Set mobile flag
		let vr=$(app.vr).offset();																	// Point at video room box									
		$("#co-iframe").css({ left:vr.left+"px",top:vr.top+"px",width:$(this.vr).width()+"px",height:$(this.vr).width()*.5625+"px" });
		this.DrawVenue();																			// Redraw venue
		this.ArrangePeople();                                                                       // Arrange people               
		let x=Math.max(0,Math.min(this.bx-avSize,$("#co-AvMe").offset().left));						// Cap me x to screen
		let y=Math.max(0,Math.min(this.by-avSize*2,$("#co-AvMe").offset().top));					// Y
		$("#co-AvMe").offset({left:x,top:y });														// Move icon there
	}

	JoinMeeting(id)																				// JOIN MEETING
	{
		id=this.pIndex[id];																			// Turn id into index		
		this.myId=id;																				// My id
		this.myEmail=this.people[id].email;															// Get my email
		this.DrawPeople();																			// Draw people avatars
		this.Draw();																				// Draw screen
		this.GoToCenter();																			// Go to center of room
		$("#splashDiv").fadeOut();																	// Fade out splash
		$("#co-top").animate({opacity:1},1000,()=>{ app.ArrangePeople(); $("#splashDiv").html("") }); // Fade in main, the arrange people
		if (app.reg) delete app.reg;																// Delete reg if there
	}

	SocketIn(event)																				// A WEBSOCKET MESSAGE
	{
		let id,i,meeting="";
		let msg=event.data;																			// Get message
		let v=event.data.split("|");																// Split message

		if (v[1]) meeting=v[1].split("~")[0];														// Get meeting id
		if (v[0] == "C") {																			// CHAT
			if (meeting != this.meetingId)	return;													// Not this meeting
			if (v[3] == "speedmeet") {																// A speed meeting
				app.people[app.pIndex[v[2]]].met=1;													// Set met flag
				app.sced.ShowLink(`japp.htm?/~${app.meetingId}~${v[2]}~${v[1]}`);					// Run video
				return;																				// Quit
				}
			else if (v[3] == "speedclose") {														// A speed meeting
				app.CloseAll(3);																	// Close video
				return;																				// Quit
				}
			id=this.pIndex[v[2]];																	// Get index from id			
			this.chat.chats.push({ dir:0, id:id, msg:v[3] });										// Archive
			if (($("#co-textDiv").length) && (this.chat.curChat == id)) {							// If chat window is open with same person
				$("#co-textDiv").append("<div class='co-textR'>"+LinkableURL(v[3])+"</div><br>");	// Add message
				$("#co-textDiv").scrollTop(10000);													// Scroll to bottom
				}
			else{																					// Send to message queue
				this.chat.queue.push({ id:id, msg:v[3] });											// Add to queue
				if ($("#co-qv-0").length) this.chat.ShowQueue();									// Show the message queue, if open	
				$("#co-queue").text(app.chat.queue.length); 										// Reset queue dot length
				$("#co-queue").show();																// Show dot
				let o=this.people[id];																// Point at person
				let str=`<div onclick="app.chat.Chat('${id}')"><b>New message from</b>
				<p><img style="width:40px;height:40px;border-radius:50px" src="${o.pic}"></p>
				<b>${o.firstName} ${o.lastName}</b><br>${o.org}<p><hr></p>
				<div style="color:#0000ff">${v[3]}</div><br>`;		
				Popup(str,5000);																	// Show popup
				}
			Sound("ding");																			// Ring the bell
			}
		else if (v[0] == "L")	{																	// MOVE
			if (meeting != this.meetingId)	return;													// Not this meeting
			id=this.pIndex[v[1]];																	// Get index from id			
			let f=v[2]-0;																			// Get floor
			let x=v[3]/100*(this.hallPos.w-avSize)+this.hallPos.x;									// Calc x from %
			let y=v[4]/100*(this.hallPos.h-avSize)+this.hallPos.y;									// Y
			x=Math.max(0,Math.min(this.bx-avSize,x));												// Cap x to screen
			y=Math.max(0,Math.min(this.by-avSize*2,y));												// Y
			this.people[id].f=f; this.people[id].x=v[3]; this.people[id].y=v[4]; this.people[id].stats=v[5]; // Update people object
			if (this.curFloor != v[2])	{ $("#co-Av-"+id).css("display","none"); return; }	 		// We're not on the same floor
			$("#co-Av-"+id).animate({ left:x+"px", top:y+"px"});									// Animate icon there
			if (v[5] == "Q")							$("#co-Av-"+id).css("display","none");		// Hide this person if quiet
			else if ($("#co-top").css("opacity") > 0)	$("#co-Av-"+id).css("display","block");		// Show them, if initted
			if (v[5].match(/^[B|R|S]/))	this.ArrangePeople();										// Arrange people at bar and rooms
			$("#co-Av-"+this.myId).css("display","none");											// Always hide my own avatar
			$("#co-At-"+id).css("display",v[5].match(/^[B|R]/) ? "none" : "block");					// Hide or show name tag
			}
		else if ((v[0] == "P") || (v[0] == "WP")) {													// Add/update people
			this.AddPeople(JSON.parse(v[1]));														// Set data								
			if (v[2] == "U")	app.DrawPeople();													// Redraw on update
			}
		else if (v[0] == "V") 	{ 																	// Add/update venue
			this.AddVenue(JSON.parse(v[1]));														// Set data				
			if (v[2] != "U")	app.ws.send(`S|${app.meetingId}`);									// Request schedule data if adding	
				else				app.DrawVenue();													// Redraw venue on update
			}
		else if (v[0] == "S") {																		// Add/update schedule
			this.AddSchedule(JSON.parse(v[1]));														// Set data
			this.sced.CheckSchedule();																// Set venue via schedule
			let qv=window.location.search.substring(1).split("&");									// Get query params
			for (let i=1;i<qv.length;++i) {															// For each one
				if (qv[i].match(/email=/i))															// If email
					$("#co-logon").val(qv[i].substr(6)).trigger("change");							// Set value
				}
			}
		else if (v[0] == "B") {																		// BROADCAST
			if (v[2].charAt() == "*") {																// If TTS
				v[2]=v[2].substr(1);																// Remove star
				this.chat.Speak(v[2]);																// Say it
				}
			Popup(`<b style="color:#990000">A message<br>from your meeting host</b><hr><br>${v[2]}<br><br>`,6000);	// Alert them
			Sound("ding");																			// Ding
			}
		else if (v[0] == "MP") {																	// Update person
			let d=JSON.parse(v[2]);																	// Objectify
			let i=this.pIndex[d.id];																// Get index
			if (d) this.people[i]=d;																// Set data								
			}
		else if (v[0] == "BB") {																	// Update message board
			for (i=0;i<this.sced.schedule.length;++i) 												// For each event
				if (this.sced.schedule[i].id == v[1]) {												// A match
					this.sced.schedule[i].content=v[2];												// Set content
					if (this.sced.schedule[i].link && this.sced.schedule[i].link.match(/bulletinboard/i))	// if BB data
						this.chat.SetBulletinMarkup(i,v[2] ? JSON.parse(v[2]) : []);						// Redraw
					if (this.sced.schedule[i].link && this.sced.schedule[i].link.match(/chalkboard/i))		// if chalk data
						$(`#co-chalk-${i}`).html(this.sced.schedule[i].content);							// Show
						break;
					}
			}
		else if (v[0].charAt(0) == "K") 	this[v[0]]=v[1];										// Set ks
	}
	
	OnMeMove(x, y, targetId)																	// REACT TO MOVING ME AVATAR
	{
		let i,link;
		targetId=targetId.replace(/co-AvMe/,"");													// It's just me
		if (targetId.match(/co-Rm-/) && (targetId != "co-Rm-0")) {									// In a room other than hall
			link=this.venue[this.curFloor][targetId.substr(6)].link;								// Get goto link
			if (link && link.match(/chat-/i)) {														// A chat link
				link=link.substr(5);																// Get just email
				for (i=0;i<app.people.length;++i)													// For each person
					if (app.people[i].email.toLowerCase() == link.toLowerCase()) {					// A match
					app.chat.Chat(i,"here", x, y);													// Open chat					
					$("#co-AvMe").animate({ left:x, top:y });										// Animate me there		
					return;																			// Quit
					}
				}
			if (link && link.match(/floor-/i)) {													// If going to a new floor
				this.CloseAll(3);																	// Close video windows
				$(window).scrollTop(0);																// Scroll to top	
				this.curFloor=link.substr(6)-0;														// Get floor index
				this.DrawVenue();																	// Draw floor
				this.ArrangePeople();																// Reaarange the
				this.GoToCenter();																	// Go to center of room
				return;
				}
			this.status="R"+targetId.substr(6);														// Status with room number
			if (link) this.sced.ShowLink(link);														// Show link id one there
			else{
				this.CloseAll();																	// Close all open dialogs
				this.status="A";																	// In active mode
				}
			}
		else if (targetId.match(/co-quiet/)) {														// ON QUIET AREA
			x=$("#co-quiet").offset().left+4;														// Center x
			y=$("#co-quiet").offset().top+4;														// Y
			$("#co-AvMe").animate({ left:x, top:y });												// Animate me there		
			this.status="Q";																		// In quiet mode
			}
		else if (targetId.match(/co-speedMeet/)) {													// ON SPEED MEETING AREA
			x=$("#"+targetId).offset().left+4;														// Center x
			y=$("#"+targetId).offset().top+4;														// Y
			$("#co-AvMe").animate({ left:x, top:y });												// Animate me there		
			app.chat.SpeedMeeting(60);																// Init speed meeting////
//			for (let i=0;i<this.people.length;++i) { this.people[i].stats="S0";	$("#co-Av-"+i).show() };													
			this.status="S"+this.curFloor;															// In speed meeting mode
			}
		else if (targetId.match(/co-coffee/)) {														// ON COFFEE BAR
			let id=targetId.substr(10);                                                             // Which one?
 			this.status="B"+id;                                                  					// Update me
  		    let str="japp.htm?/~"+this.meetingId+"~coffeebar-"+this.curFloor+"-"+id;				// Assume Jitsi
 			if ((this.status == "B0-0") && this.coffeebarLink) 	str=this.coffeebarLink;				// Use spec'd link for main bar
			this.sced.ShowLink(str); 																// Go to the coffee bar 
//			for (let i=0;i<this.people.length;++i) { this.people[i].stats="B0-0"; $("#co-Av-"+i).show() };													
			}
		else{																						// General click
			this.CloseAll();																		// Close all open dialogs
			this.status="A";																		// In active mode
			}
		x=Math.max(this.hallPos.x,Math.min(this.hallPos.x2,x));										// Cap x to screen
		y=Math.max(this.hallPos.y,Math.min(this.hallPos.y2,y));										// Y
		this.ReportLocation(x,y,this.status,true);													// Report my move in pixels
		this.chat.curChat=-1;																		// Not chatting with anyone
	}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// AVATAR MOVEMENT
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	ReportLocation(x, y, status, pixels)														// REPORT LOCATION TO SERVER
	{
		if (this.privateMode)	status="Q";															// Force status quiet
		if (pixels) {																				// If reporting from pixels
			x=(x-this.hallPos.x)/(this.hallPos.w-avSize);											// As % of width
			y=(y-this.hallPos.y)/(this.hallPos.h-avSize);											// Height
			}
		x=(x*100).toFixed(2);																		// Scale x 0-100
		y=(y*100).toFixed(2);																		// y
		if (app.ws)	app.ws.send(`L|${app.people[app.myId].id}|${app.curFloor}|${x}|${y}|${status}`);// Send Location message
	}

	GoToCenter()																				// MOVE TO CENTER HALL OR SPECIFIC SPOY
	{
		let x=(Math.random()*20+40)/100;															// Hover X in center
		let y=(Math.random()*20+40)/100;															// Y
		app.ReportLocation(x,y,"A",false);															// Report location in precent
		$("#co-AvMe").animate({ left:this.bx*x, top:this.by*y });									// Animate me there	
	}

	ArrangePeople()                                                                             // ARRANGE COFFEE BAR / ROOM MEMBERS
    {
		this.ShowHidePeople();																		// Hide/show people
		this.ArrangeSpeedMeeters();																	// Arrange people speed meeting
		this.ArrangeCoffeeBars();																	// Arrange coffee bars
		this.ArrangeRooms();																		// Arrange Rooms
		$("#co-Av-"+this.myId).css("display","none");												// Always hide my own avatar
	}

	ShowHidePeople()																			// HIDE OR SHOW AVATARS
	{
		let i,o;
		this.speedMeeters=[];
		let cf=this.curFloor;																		// Current floor
		let np=this.people.length;																	// Number of people
		let sf="S"+this.curFloor;																	// Current floor
		for (i=0;i<np;++i) {																		// For each person
			o=this.people[i];																		// Point at them
			if ((o.stats == sf) && !o.met) this.speedMeeters.push(i); 								// If unmet person in a speed meeting, add to array
			if ((cf != o.f) || (o.stats == "Q"))  $("#co-Av-"+i).css("display","none");				// Hide people not on floor or quiet
			else{
				$("#co-Av-"+i).css({ display:"block",top:o.y+"%",left:o.x+"%" });					// Show avatar
				$("#co-At-"+i).html(`${o.firstName}<br>${o.lastName}`);								// Set label
				$("#co-Ap-"+i).prop("src",o.pic ? o.pic : "img/avyou.png");							// Set image
				}
			}	
	}

	ArrangeSpeedMeeters()																		// ARRANGE SPEED MEETERS
	{
		let i;					
		let people=this.speedMeeters;																// Set meeters
		let x=$("#co-speedMeet-"+this.curFloor).offset().left+2;                                    // left side of icon
		let y=$("#co-speedMeet-"+this.curFloor).offset().top-avSize-2;                            	// Top side of icon
		let inc=avSize+1;                                                              	            // Spacing between meeters
		people=ShuffleArray(people);																// Randomize			
		for (i=0;i<people.length;++i) {                                                            	// For each meeter
			$("#co-Av-"+people[i]).css("display","block");											// Show it
   			$("#co-At-"+people[i]).css("display","none");                                         	// Hide me tag
		   	$("#co-Av-"+people[i]).animate({ left:x, top:y},0);           							// Move them
        	if (i < 3) y-=inc;																		// Only show 1st 4
			}
 	}

	ArrangeCoffeeBars()																			// ARRANGE COFFEE BARS
	{	
		let i,j,x,y,w,o,bar,inc;
		let cf=this.curFloor;																		// Current floor
		let np=this.people.length;																	// Number of people
		if ($("#co-coffee-"+cf+"-0").length) {														// If a main coffee bar
      		x=$("#co-coffee-"+cf+"-0").offset().left+30;                                    		// left side of bar
       		y=$("#co-coffee-"+cf+"-0").offset().top+8;                      			 			// On top of bar area
    		w=$("#co-coffee-"+cf+"-0").width()-60-avSize;                                  			// Width of space
   			}
		for (j=0;j<this.venue[cf].length;++j) {                             		   	 			// For each room
            bar=[];                                                                                 // New array
			for (i=0;i<np;++i) {																	// For each person
				if ((this.people[i].stats) == "B"+cf+"-"+j) 										// In a bar		
					bar.push(i); 																	// Add to array
				}
			if (bar.length && j) {																	// If not main hall
                x=$("#co-coffee-"+cf+"-"+j).offset().left-avSize/2+27; 	                			// Left
   				y=$("#co-coffee-"+cf+"-"+j).offset().top+36;                            			// Top      
                w=$("#co-Rm-"+j).height()-avSize-34;                                                // Get size                                             
                }
            inc=avSize+2;                                                                           // Spacing between barmates
            if (bar.length > 1) inc=Math.min(inc,w/(bar.length-1));                                 // Squeeze them in?
			for (i=0;i<bar.length;++i) {                                                            // For each barmate
                if (bar[i] == this.myId) $("#co-AvMe").animate({ left:x, top:y},0)                  // Move me
              	else  					 $("#co-Av-"+bar[i]).animate({ left:x, top:y},0);           // Move them
				$("#co-At-"+bar[i]).css("display","none");                                         	// Hide me tag
                if (j)  y+=inc;    else x+=inc;                                                  	// Advance
				}
			}
	}

	ArrangeRooms()																				// ARRANGE ROOMS
	{
		let n,ox,y2,rms=[];																			
		let x,w,y,h,i,j,x2,o,inc;					
		let cf=this.curFloor;																		// Current floor
		let np=this.people.length;																	// Number of people
		for (i=0;i<this.venue[cf].length;++i) rms.push([]); 										// For each room, make room arrays
		for (i=0;i<np;++i) {																		// For each person
			o=this.people[i];																		// Point at stats
			if (o.f != cf) {																		// Person not on this floor
				try{
					if ((ox=this.roomPortals.indexOf("F"+o.f)) == -1)	continue;					// No portal in current floor
					ox=this.roomPortals.substr(0,ox).match(/R\d+(?!.*R\d+)/)[0].substr(1);			// Get room
					if (o.stats != "Q")	$("#co-Av-"+i).css("display","block")						// Show unless quiet
					rms[ox].push(i);																// If this floor in child path, add to room
					} catch(e) { trace(e); }
				}
			else if (o.stats && (o.stats.charAt(0) == "R"))  rms[o.stats.substr(1)].push(i);		// If in a room, add person to it
			}
		for (j=1;j<rms.length;++j) {																// For each room
			let p=this.venue[cf][j].pos;															// Room pos
			x=ox=p.left+4;																			// Left side
			x2=x+p.wid-avSize-8;																	// Width of space
			w=avSize+2;																				// Full size spacing
			n=rms[j].length;																		// Number of people
			y2=p.top+50;																			// Top
			y=p.top+p.hgt-avSize-5;																	// Bottom
			w=Math.min(Math.sqrt(((x2-ox)*(y-y2)/n)),avSize+2);										// Set avatar spacing
			if (this.people[this.myId].stats == "R"+j)												// If I'm in this room		
				$("#co-AvMe").animate({ left:x, top:y },0),x+=w; 									// Move me in
			for (i=0;i<n;++i) {																		// For person in room
				if (rms[j][i] == this.myId)	continue;												// Skip me
				$("#co-Av-"+rms[j][i]).animate({ left:x, top:y },0);								// Move there
				$("#co-At-"+rms[j][i]).css("display","none");										// Hide me tag
				x+=w;																				// Advance
				if (x > x2)	{ x=ox;	 y-=w; }														// Next row
				if (y < y2)	break;																	// Quit if too many
				}
			}
		$("#co-Av-"+this.myId).css("display","none");												// Always hide my own avatar
	}

 	CloseAll(mask=0)                                                                        	// CLOSE ALL OPEN DIALOGS
    {
		$("#co-chat").remove();                                                                     // Close chat if open
        $("#co-card").remove();     																// Card                                                                
        $("#co-sched").remove();   																	// Schedule                                                                 
        $("#co-people").remove();        															// People                                                           
		$("#co-gItemD").remove();        															// People                                                           
		let src=$("#co-iframeFrame").prop("src");													// Get iframe link		
		if (src) mask=3;																			// If an open iframe close it
		if (mask&1)	$("#co-iframe").remove();														// Remove iframe if flag set                                                                   
		if (mask&2 && this.videoWin)  this.videoWin.close();										// Close open video window
		else if (this.videoWin)		  this.videoWin.focus();										// Put it on front
    }

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// DATA
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	AddPeople(people)																				// ADD PEOPLE TO MEETING
	{
		let i,o;
		people.sort((a,b)=>{ return (a.id.split("~")[1]-0 > b.id.split("~")[1]-0) ? 1 : -1 });			// Sort by numeric id
		this.people=people;																				// Set data
		for (i=0;i<people.length;++i) {																	// For each person
			o=this.people[i];																			// Point at them
			if (!o.stats)	o.stats="Q";																// Quiet unregistered people
			o.met=0;																					// Not met yet
			o.firstName=o.firstName ? o.firstName : "";													// Null out undefined
			if (o.email == this.myEmail) this.myId=i;													// Set myid
			if (o.role && o.role.match(/info/i)) this.infoDeskId=i;                                  	// Info person  
			this.pIndex[people[i].id]=i;																// Save index by full id
		}
	}

	AddSchedule(sced)																				// ADD SCHEDULE
	{
		let i,o,s,off=0;
		for (i=0;i<sced.length;++i)	{																	// For each event
			if (sced[i].day == 0)  s=sced.splice(i,1);													// If setup, copy and remove it
			}
		if (s && s[0] && s[0].bar && s[0].bar.match(/UTC/i)) off=s[0].bar.substr(3)*-60;				// Get offset from UTC
		for (i=0;i<sced.length;++i)	{																	// For each event
			o=sced[i];																					// Point at it
			if (o.start != "!")	o.start=this.sced.TimeToMins(o.start,off-0);							// Start to mins, unless an away event
			o.end=this.sced.TimeToMins(o.end,0);														// Duration to mins
			if (o.link && (o.floor == 0) && (o.room == 0) && o.link.match(/^coffeebar/i)) {				// Set main coffee bar link
				app.coffeebarLink=o.link.substring(10);													// Set in app
				o.link="";																				// Remove from even itself
				}
			}		
		this.sced.offset=off;																			// Set offset
		this.sced.schedule=sced;																		// Set data
		if (s[0].start.charAt(0) == "*")	this.sced.meetingStart=new Date();							// Use today
		else								this.sced.meetingStart=new Date(s[0].start);				// Set start date
		if (s[0].end.charAt(0) == "*")		this.sced.meetingEnd=new Date();							// Use today
		else								this.sced.meetingEnd=new Date(s[0].end);					// Set end date
		this.sced.schedule.sort((a,b)=>{ return (a.day > b.day) ? 1 : -1 });							// Sort by day
		for (i=0;i<this.sced.schedule.length;++i)	this.sced.schedule[i].index=i;						// Set index
	}

	AddVenue(ven)																					// ADD VENUE DATA
	{
		let i,o;
		this.venue=[];
		ven.sort((a,b)=>{ return (a.floor-0 > b.floor-0) ? 1 : -1 });									// Sort by floor
		for (i=0;i<ven.length;++i) {																	// For each room
			o=ven[i];																					// Point at room
			o.olink=o.link;																				// Save original link
			if (!this.venue[o.floor])	this.venue[o.floor]=[];											// Create new array if empty
			this.venue[o.floor].push(o);																// Add room to floor	
			}
		for (i=0;i<this.venue.length;++i) 																// For each floor
			if (app.venue[i])																			// If valid
				this.venue[i].sort((a,b)=>{ return (a.room-0 > b.room-0) ? 1 : -1 });					// Sort by room
		}

	DrawPeople()																					// ADD PEOPLE TO MEETING
	{
		let i,o,str="";
		$("[id^=co-Av-]").remove();		$("#co-AvMe").remove();											// Remove existing people
		for (i=0;i<this.people.length;++i) {															// For each person
			o=this.people[i];																			// Point at them
			o.x=Math.max(0,Math.min(o.x,95));															// Cap x to screen
			o.y=Math.max(0,Math.min(o.y,95));															// Cap x to screen
			if (!this.people[i].pic)	this.people[i].pic="img/avyou.png";								// Use generic pic
			str+=`<div class="co-avatar" id="co-Av-${i}" style="top:${o.y}%;left:${o.x}%;
			display:${(o.stats == "Q") ? "none" : "block"}" title="${o.firstName} ${o.lastName}"> 
			<div style="width:${avSize}px;height:${avSize}px;overflow:hidden;border-radius:64px;display:inline-block">
			<img id="co-Ap-${i}" src="${o.pic}" style="width:${avSize}px;min-height:${avSize}px"></div>
			<div id="co-At-${i}">${o.firstName}<br>${o.lastName}</div></div>`;							// Add person
			}
		str+=`<div class="co-me" id="co-AvMe" style="width:${avSize}px;height:${avSize}px">
		<img src="img/avme.png" width="100%">
		<div id="co-queue" class="co-qNum" style="margin:-15px 0 0 13px"></div></div>`;					// Add me
		$("body").append(str);																			// Add to body

		$("[id^=co-Av-]").on("click", (e)=>{ this.chat.ShowCard(e.currentTarget.id.substr(6)); }); 		// ON PERSON CLICK
		$("[id^=co-Av-]").droppable( { drop:(e)=>{ this.chat.ShowCard(e.target.id.substr(6)); }}); 		// ON DROP ON PERSON
		$("#co-AvMe").draggable({ containment:"body" });												// I'm draggable
		$("#co-AvMe").on("click", (e)=>{ this.chat.ShowQueue();	}); 									// ON ME CLICK
	}
	
	DrawVenue()																						// DRAW VENUE
	{
		let i,j,o,row,n,x,sc;
		this.bx=$("body").width(),		this.by=window.innerHeight;										// Body size
		let p=this.venue[this.curFloor][0].params;														// Point at all params
		if (p.avSize)		avSize=p.avSize-0;															// Use size if set
		if (p.vRoom >= 0)	this.vr="#co-Rm-"+p.vRoom;													// Use video room if set
		sc=this.sced.GetEventByRoom(this.curFloor, 0);													// Point at schedule for hall																			
		o=this.venue[this.curFloor][0];																	// Point at room
		let offx=p.menu&1 ? avSize+16 : 0;																// Account for quiet icon
		offx+=p.menu&32 ? avSize+16 : 0;																// And speed icon

		let menu=`<div id="co-menDiv" style="z-index:0;width:100%;text-align:left;position:absolute">
			<img src="img/speedmeet.png" id="co-speedMeet-${this.curFloor}" 
			style="height:${avSize+8}px${p.menu&32 ? "" : ";display:none;"};cursor:grabbing;margin-left:8px" title="Speed meeting">
			<img src="img/quietarea.png" id="co-quiet" 
			style="height:${avSize+8}px;margin:8px 0 0 8px${p.menu&1 ? "" : ";display:none;"};cursor:grabbing" title="Go private">
			<img id="co-coffee-${this.curFloor}-0" src="img/coffeebar.png" style="${(sc.bar > 0) ? "" : "display:none;"}
			width:264px;margin-top:-36px;margin-left:calc(50% - 136px - ${offx}px);z-index:3;cursor:grabbing" title="Main coffeebar">
			<div style="float:right;margin:16px 8px 0 0">			
				<img src="img/schedule.png" id="co-schedule"  style="height:36px;cursor:pointer;margin-right:8px${p.menu&2 ? "" : ";display:none" }" title="See meeting schedule">
				<img src="img/people.png" 	id="co-attendees" style="height:36px;cursor:pointer;margin-right:8px${p.menu&4 ? "" : ";display:none" }" title="See other attendees">
				<img src="img/bulletin.png" id="co-bbIcon" style="height:36px;margin-right:8px;cursor:pointer${p.menu&8 ? "" : ";display:none" }" title="Message board">
				<img src="img/whiteboard.png" id="co-whiteIcon" style="height:36px;margin-right:8px;cursor:pointer${p.white ? "" : ";display:none" }" title="White board">
				<img src="img/calendar.png" id="co-calIcon" style="height:36px;margin-right:8px;cursor:pointer${p.cal ? "" : ";display:none" }" title="Calendar">
				<img src="img/info.png" id="co-infoDesk"  style="height:36px;cursor:pointer${p.menu&16 ? "" : ";display:none" }" title="Get help!">
			</div></div>`;
		let str=`<div id="co-grid" class="co-venue" style="`;
		if (!isSmall) str+=`
			grid-template-columns:repeat(${o.params.cols}, 1fr);
			grid-template-rows:repeat(${o.params.rows}, 1fr);`;
		str+=`grid-gap:${o.params.gap}px;background-color:${o.params.bcol}">`;							// Grid base
		
		let rs=0,re=1,cs=1,ce=2,content;																/// Mobile size positions
		let gals=[];
		this.roomPortals=[];																			// Clear portals
		this.curContent="";
		for (i=0;i<this.venue[this.curFloor].length;++i) {												// For each room
			o=this.venue[this.curFloor][i];																// Point at room
			if (isSmall) { rs++; re++ }																	// Advance rows for mobile
			else		 { rs=o.rs; re=o.re; cs=o.cs; ce=o.ce; };										// Use set values
			app.roomPortals+="R"+i+"="+o.portal;														// Add portal info
			
			sc=this.sced.GetEventByRoom(this.curFloor,i)												// Point at schedule room																		
			o.link=o.olink ? o.olink : "";																// Reset original link
			if (sc.link) o.link=sc.link;																// Set room link
			this.curContent+=o.link+sc.content;															// Add to current content hash
			content=sc.content ? sc.content : "";														// Set content if any
			if (sc.link && sc.link.match(/^gallery/i)) {												// If a gallery, 
				content=this.sced.GetGalleryData(sc).content; 											// Get gallery content
				gals[sc.room]=1;																		// Flag to set sizing
				}
			else if (sc.link && (sc.link.toLowerCase() == "bulletinboard")) {							// If a bulletin, 
				content=this.chat.GetBulletinBoard(sc.index); 											// Get bulletin board content
				gals[sc.room]=1;																		// Flag to set sizing
				}
			else if (sc.link && (sc.link.toLowerCase() == "chalkboard")) {								// If a chalkboard, 
				content=this.chat.GetChalkBoard(sc.index); 												// Get chalk board content
				gals[sc.room]=1;																		// Flag to set sizing
				}
			content=this.sced.SetMacros(i,content);														// Set content macros
		
			if (!o.rug)		o.rug=this.venue[this.curFloor][i-1].rug;									// Use flooring from room above if not set
			str+=`<div class="co-room" style=";grid-column-start:${cs};grid-column-end:${ce};grid-row-start:${rs};grid-row-end:${re};
			${(o.rug.charAt(0) == "#") ? "background-color:"+o.rug : "background-image:url('"+o.rug+"')"}
			;height:100%;${o.link ? ";cursor:grabbing" : ""}${o.css ? ";"+o.css : ""}">
			<div id="co-Rm-${i}" style="height:100%;width:100%;position:relative">`;
			if (!i)	str+=menu;																			// Add menu to hallway
 			if (o.title && i && (o.title.charAt(0) != "*")) str+=`<div class="co-roomHdr">${o.title }</div>`;	// Add title to non-hallways
			str+="<div id='co-roomContent-"+i+"' style='pointer-events:none;display:inline-block;width:100%'>"+content+"</div>";	// Add content wrapped in no-event div
			if (i && (sc.bar > 0)) str+=`<img id="co-coffee-${this.curFloor}-${i}" 
			style="position:absolute;cursor:grabbing;left:calc(100% - ${(avSize/2)+27}px);top:-4px;width:52px" src="img/coffeecup.png" title="Coffeebar">`;
           	if (sc.live > 0)   str+=`<img style="position:absolute;left:10px;top:12px;width:32px" src="img/live.png">`;
          	str+="</div></div>";		
			}
		this.roomPortals=this.roomPortals.toUpperCase();												// Force UC
		$("#co-main").html(str.replace(/\t|\n|\r/g,""));												// Add venue
		$("#co-menDiv").offset({ left:$("#co-Rm-0").offset().left, top:$("#co-Rm-0").offset().top+$("#co-Rm-0").height()-avSize-22});	// Force to bottom of hallway
		for (i=0;i<this.venue[this.curFloor].length;++i) {												// For each room
			this.venue[this.curFloor][i].hgt=$("#co-roomContent-"+i).height();							// Save room height
			this.venue[this.curFloor][i].pos=$("#co-Rm-"+i).offset();									// Save offset position
			this.venue[this.curFloor][i].pos.wid=$("#co-Rm-"+i).width();								// Width
			this.venue[this.curFloor][i].pos.hgt=$("#co-Rm-"+i).height();								// Height
			if (gals[i]) { 																				// If something there
				$("#co-roomContent-"+i).css({"pointer-events":"auto","overflow-x":"hidden" });			// Set CSS
				$("#co-galBase-"+i).height(Math.max($("#co-Rm-"+i).height()-60, isSmall? 300 : 0));		// Get hgt, min of 300 for mobile
				}
			}
		$("[id^=co-coffee-], #co-quiet, [id^=co-Av-], [id^=co-speedMeet-], [id^=co-Rm-]").droppable({	 					// ON AVATAR DROP
		    accept:"#co-AvMe",																			// Only the me icon
			over: (e, ui)=> { ui.draggable.css("cursor", "grabbing"); },								// Show I'm over a droppable
  			out:  (e, ui)=> { ui.draggable.css("cursor", "grab"); },									// Normal cursor
			drop: (e, ui)=> { ui.draggable.css("cursor", "grab"); this.OnMeMove(e.pageX,e.pageY,e.target.id);}	// When dropped action		
			});
		$("#co-schedule").on("click", 			 (e)=>{ this.sced.ShowSchedule(); });					// ON SCHEDULE BUT
		$("#co-infoDesk").on("click", 			 (e)=>{ this.chat.Chat(this.infoDeskId,"infoDesk"); });	// ON HELP BUT
		$("#co-bbIcon").on("click", 			 (e)=>{ this.chat.GetBulletinBoard("", this.curFloor)}); // ON BULLETIN BUT
		$("#co-calIcon").on("click", 			 (e)=>{ this.sced.ShowLink(p.cal) }); 					// ON CALENDAR BUT
		$("#co-whiteIcon").on("click", 			 (e)=>{ this.sced.ShowLink(p.white) }); 				// ON WHITEBOARD BUT
		$("#co-attendees").on("click", 			 (e)=>{ this.sced.ShowAttendees(this.infoDeskId,true); }); // ON PEOPLE BUT
		$("[id^=co-bull-]").scrollTop(10000);															// Scroll bulletin boardd to bottom
		}


} // APP CLASS CLOSURE

// HELPERS //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////	

	function trace(msg, p1, p2, p3, p4)										// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function GetTextBox(title, content, def, callback, x, y)										// GET TEXT LINE BOX
	{
		$("#confirmBoxDiv").remove();																	// Remove 
		$("body").append("<div class='co-confirm' id='confirmBoxDiv' style='text-align:center'></div>");	// Add box								
		if (x != undefined)		$("#confirmBoxDiv").css({ left:x+"px", top:y+"px" });					// Position if set
		let str="<img src='img/logo.png' width='64'/><br>";												// Logo					
		str+="<p style='font-size:14px; color:#666'><b>"+title+"</b></p>";
		str+="<p>"+content+"<p>";
		str+="<p><input class='co-is' style='width:95%' type='text' id='co-revText' value='"+def+"'>";
		str+="<img id='co-talkBut'src='img/talkbut.png' style='vertical-align:-7px;margin-left:-20px;cursor:pointer'></p>";
		str+="<div id='dialogOK' class='co-bs' style='background-color:#009900'>OK</div>";
		str+="<div id='dialogCancel' class='co-bs' style='margin-left:8px;background-color:#999'>Cancel</div></div>";
		$("#confirmBoxDiv").html(str);																	// Add to div
		$("#co-revText").focus();																		// Focus on button
		
		$("#co-talkBut").on("click", ()=>{app.chat.Listen()});															// Start STT
		$("#co-revText").on("change", function() {	callback($("#co-revText").val()); $("#confirmBoxDiv").remove(); });	// ON ENTER
		$("#dialogOK").on("click", function() {	callback($("#co-revText").val()); $("#confirmBoxDiv").remove(); });		// ON OK 
		$("#dialogCancel").on("click", function() {	$("#confirmBoxDiv").remove(); });									// ON CANCEL
		}

	function Sound(sound, mute)																		// PLAY SOUND
	{
		let snd=new Audio();																			// Init audio object
		if (sound.match(/\.mp3/i))		snd=new Audio(sound)											// If an MP3 file
		else							snd=new Audio("img/"+sound+".mp3");								// Use built in mp3
		if (!mute)	{																					// If not initing or muting	
			snd.volume=100/100;																			// Set volume
			snd.play();																					// Play it
			}
	}

	function Popup(msg, time, div)																	// TIMED POPUP
	{
		let str="";
		$("#co-popupDiv").remove();																		// Kill old one, if any
		if (document.fullscreenElement)	document.exitFullscreen();										// Force non-full screen 
		str+="<div id='co-popupDiv' class='co-popup'>"; 												// Add div
		if (time == -1) {																				// If has close but
			time=100000;																				// Increase time
			str+="<img id='pu-close' src='img/closedot.gif' style='float:right;cursor:pointer'>";		// Add close button
			}
		str+=msg+"</div>"; 																				// Add div
		$(div ? "#"+div : "body").append(str);															// Add popup to div or body
		$("#pu-close").click(function() { $("#co-popupDiv").remove(); });								// Remove on click of close but
		$("#co-popupDiv").fadeIn(500).delay(time ? time : 2000).fadeOut(500)							// Animate in and out		
	}

	function trace2(msg, p1, p2, p3, p4)															// MOBILE CONSOLE 
	{
		trace(msg);
		Popup(msg,10000)
		$("#co-Rm-2").html(">"+msg+"<")
	}

	function ShuffleArray(array) 																	// SHUFFLE ARRAY
  	{	
		let currentIndex= array.length,temporaryValue,randomIndex;
	  	while (currentIndex !== 0) {																	// While there remain elements to shuffle...
			randomIndex=Math.floor(Math.random()*currentIndex);											// Pick a remaining element...
    		currentIndex-=1;
   			temporaryValue=array[currentIndex]; 														// And swap it with the current element.
       	 	array[currentIndex]=array[randomIndex];
    		array[randomIndex]=temporaryValue;
  			}
		  return array;																					// Return shuffled array
	}

	function LinkableURL(s) 																		// URL LINK CONVERSION
	{
		let u;
		if (s && s.match(/http:\/\/|https:\/\//i)) {													// If an http or https
			u="http"+s.match(/http(.*?)$/i)[1];															// Extract it													
			s=s.replace(/http(.*?)$/i,`<a href="${u}" target="_blank">${u}</a>`);						// Add as link
			}
		else if (s && s.match(/www\./i)) {																// If www.
			u="http://www."+s.match(/www\.(.*?)$/i)[1];													// Extract it													
			s=s.replace(/www\.(.*?)$/i,`<a href="${u}" target="_blank">${u}</a>`);						// Add as link
			}
		return s;																						// Return url
	}

	function ConvertFromGoogleDrive(url)															// CONVERT GOOGLE DRIVE/DROPBOX LINK TO DIRECT LINK
	{
		if (url && url.match(/drive\.google/i)) {														// A google drive image
			var id=url.match(/\?id=(.+)/i);																// Extract id
			if (!id)																					// Nothing there
				id=url.match(/\/d\/(.*?)\//);													 		// Try this way
			if (id)																						// An id found
				url="//drive.google.com/uc?export=view&id="+id[1];									// Construct 'direct' link
			}
		else if (url && url.match(/dropbox\.com/i)) {													// A dropbox link
			var id=url.match(/\/s\/(.*)\?dl=0/i)[1];													// Extract id
			url="https://dl.dropboxusercontent.com/s/"+id;												// Construct direct link
			}
		return url;																						// Return link
	}

</script>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-179601831-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-179601831-1');
</script>

</body>
</html>
