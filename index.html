<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=.75, shrink-to-fit=yes">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
	<script src="lib/jquery.ui.touch-punch.min.js"></script>
	<link REL="SHORTCUT ICON" HREF="img/favicon.ico">
	<title>èt • al Meeting</title>
</head>
<style>
	:root 		{ 	--mobileOff:0px; --avSize:45px}
	body 		{ 	font-family:Verdana,Geneva,sans-serif; font-size:10px; padding:0px; margin:0px; box-sizing:content-box; }
	.co-splash 	{ 	position:absolute; width:100%; top:0; left:0; text-align:center; margin-top:15%; display:none; font-size:12px; }
	.co-top		{	opacity:0; overflow:hidden;height:calc(100vh - var(--mobileOff)); z-index:0; }
	.co-venue 	{	display:grid; grid-template-columns: 25% 50% 25%;  text-align:center; height:100%; 
					text-shadow:2px 2px 3px #8a7a56; border-radius:8px; color:#fff; 
					user-select:none; -webkit-user-select:none; -ms-user-select:none; }
	.co-room 	{	background-repeat:repeat; border: 2px solid#777; }
	.co-roomHdr	{	width:100%; height:26px; text-align:center; color:#fff; background-color:#777; font-size:16px; }
	.co-roomTitle {	font-size:18px;  color:#000; pointer-events:none; margin-top:12px; text-shadow: -3px -3px 6px #ccc, 3px 3px 6px#ccc; }
 	.co-avatar 	{	position:absolute; cursor:pointer; left:50%; top:50%; display:none;	font-size:12px; text-align:center; 
					text-shadow: -2px -2px 4px #ccc, 2px 2px 2px #ccc; }
	.co-me 		{	position:absolute; cursor:url(img/move.cur),auto; left:50%; top:50%; border-radius:64px; display:none; width:var(--avSize);  height:var(--avSize); }
	.co-qNum 	{	color:#fff; text-align:center; font-size:9px; border-radius:16px; background-color:#ff0000; 
					border:1px solid white; cursor:pointer; margin:-14px 0 0 calc(var(--avSize) - 4px); width:12px; height:12px; display:none; }
	.co-card 	{	position:absolute; width:300px; height:150px; background-color:#fff; border-radius:8px;
					border:1px solid #666; padding:24px; text-align:center; font-size:14px; box-shadow:3px 3px 6px #666; }
	.co-qlist 	{	position:absolute; width:274px; height:300px; background-color:#fff; border-radius:8px;
					border:1px solid #666; padding:12px; text-align:center; font-size:12px; box-shadow:3px 3px 6px #666; }
	.co-chat	{	position:absolute; width:250px; height:320px; background-color:#fff; border-radius:16px;
					border:1px solid #666; padding:24px; text-align:center; font-size:14px; box-shadow:3px 3px 6px #666; }
					.co-qlist 	{	position:absolute; width:274px; height:300px; background-color:#fff; border-radius:8px;
					border:1px solid #666; padding:12px; text-align:center; font-size:12px; box-shadow:3px 3px 6px #666; }
	.co-people 	{	position:absolute; width:274px; height:50vh; background-color:#fff; border-radius:8px; z-index:2;
					border:1px solid #666; padding:12px; font-size:12px; box-shadow:3px 3px 6px #666; }
	.co-textR 	{	background-color:#dddddd; border-radius:16px; padding:2px 8px; width:fit-content; max-width: 66%; margin:5px 0; clear:both; text-align:left; }
	.co-textS 	{	background-color:#0099ff; border-radius:16px; padding:2px 8px; width:fit-content; max-width: 66%; margin:5px 0; clear:both; float:right; color:#fff; text-align:right}
	.co-video	{	position:absolute; background-color:#fff; border-radius:4px; width:40%;
					border:1px solid #666; padding:8x; box-shadow:3px 3px 6px #666}
					.co-is 		{	border-radius:16px; padding:0 8px; width:250px; height: 24px; border:1px solid #999; font-size: 13px; }
	.co-logon 	{	border-radius:16px; padding:0 8px; width:200px; height: 24px; border:1px solid #999; font-size: 13px; text-align:center; }
	.co-is 		{	border-radius:16px; padding:0 8px; height: 24px; border:1px solid #999; font-size: 13px; }
	.co-bs 		{	display:inline-block; border-radius:16px; padding:0 8px; border:1px solid #eee; font-size: 13px; 
					cursor:pointer; z-index:2; padding-bottom:1px; color:#fff}
	.co-popup 	{	position: absolute;  width: auto; padding: 12px; left: calc(50% - 100px); top: calc(50% - 50px);
					border-radius: 8px; background-color: #eee; border: 1px solid #999; box-shadow: 4px 2px 12px 2px #aaa; 
					font-size: 14px; text-align:center; display: none; }

	body ::-webkit-scrollbar { width: 9px; height:8px } 
	body ::-webkit-scrollbar-track { background: transparent; }
	body ::-webkit-scrollbar-thumb { border-radius:8px ;background:#a4baec }
	body ::-webkit-scrollbar-thumb:hover { background: #a4baec }

</style>
<body>

	<div id="co-top" class="co-top">
		<div id="co-main"></div>
	</div>
	<div id="splashDiv" class="co-splash">
		<img src="img/logo.png" alt="" style="width: 20%"><br><br>
		<p style="color:#000;font-size:14px"><em>A people centered virtual meeting tool</em></p>
		<br><br>
		<div id="co-splash2"><input type="text" id="co-logon" class="co-logon" placeholder="Type email to join"><br><br> 
			<b style="color:#000">In order to use Zoom, we need to open it as a popup.</b>
			<p>Most browsers block pop-ups from opening.<br>
			The address bar will show a red icon on the right.<br>
			Allow this site to always show popups.</p>
		</div>
	</div>

<script>

	let app=null;																					// Holds app
	let	avSize=45;																					// Avatar size
	let butCol="#2d6ab3"																			// Color  of vutton and ui

	$(window).resize(function() { if (app) app.Draw();	  })                                      	// ON WINDOW RESIZE
	window.addEventListener("beforeunload", function(event) { app.ReportLocation(.5,.5, "Q") });	// Close me out from server
		
	$(document).ready(function() {								           							// ON PAGE LOADED
		isMobile=navigator.userAgent.match(/(ipad|iphone|ipod|android)/i) ? true : false;			// Set mobile flag
		document.documentElement.style.setProperty("--avSize",avSize+"px");							// Set CSS var for avatar size
		if (isMobile) document.documentElement.style.setProperty("--mobileOff","100px"); 			// Set CSS mobile var
		var url=window.location.search.substring(1);						   						// Get query string
		let meetingId=url ? url : 1;																// Set meeting id
		app=new App(meetingId);                                      								// Alloc app
		$("#splashDiv").fadeIn();																	// Fade in splash

		$("#co-logon").on("change",()=>{															// ON LOGON
			let i,pid=$("#co-logon").val();															// Get value
			for (i=0;i<app.people.length;++i) 														// For each person
				if (app.people[i].email.trim().toLowerCase() == pid.trim().toLowerCase())			// If a match
					break;																			// Quit looking
			if (i == app.people.length) {															// Email not found
				alert("This email was not found, please try again, or contact your meeting host"); // Alert
				return;																				// Quit																				
				}
			app.InitProject(meetingId,i);															// Init project		
			app.Draw();																				// Draw screen
			app.ReportLocation(.5,.5);																// Report location to set server myId
			$("#splashDiv").fadeOut();																// Fade out splash
			$("#co-top").animate({opacity:1},1000,()=>{ app.ArrangePeople() });						// Fade in main, the arrange people
			$("[id^=co-Av]").fadeIn(1500) 															// Fade in avatars
			$("#co-Av-"+app.myId).hide();															// Hide my own
			for (i=0;i<app.people.length;++i) 														// For each person
				if (app.people[i].stats == "Q")	$("#co-Av-"+i).hide();								// Hide people who are quiet
			if (pid.toLowerCase() == "demo") Demo();												// Run demo
		});
	
		function Demo()	{																			// DEMO MODE
			this.demoNum=1;
			setInterval(()=>{
				let i=Math.floor(Math.random()*app.people.length);									// Random person
				let x=Math.floor(Math.random()*70)+26;												// Random x 
				let y=Math.floor(Math.random()*80)+10;												// Random y 
				app.ws.send(`L|${app.meetingId}~${i}|${x}|${y}|A`); 								// Send location message
				++this.demoNum;
				if (!(this.demoNum%6)) {
					$("#co-queue").show();
					app.queue.push({ id:i, msg:"Got a minute to talk?" });
					$("#co-queue").text(app.queue.length); 	$("#co-queue").show();	
					}},15000);																		// Every 15 seconds																				
		}

		$(window).on("keydown",function(e) {														// HANDLE KEYPRESS
			if ((e.which == 84) && e.altKey && e.ctrlKey)	{										// Test key (Ctrl+Alt+T)
				}
			});
	});	
 
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// APP
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class App  {																					

	constructor(meetingId)   																// CONSTRUCTOR
	{
		app=this;																					// App global pointer
		this.scale=1;																				// Scale
		this.meetingId=""+meetingId;																// Meeting id
		this.myId="";																				// My unique id
		this.curFloor="A";																			// Current floor
		this.venue="";																				// Venue frame
		this.people=[];																				// Holds attendees
		this.rooms=[];																				// Holds rooms
		this.chats=[];																				// Holds chats
		this.schedule="{}";																			// Holds schedule
		this.queue=[];																				// Contact queue
		this.pIndex=[];																				// Get people index from id
		this.status="";																				// My status
		this.infoDeskId=6;																			// IF of info desk person
		this.coffeeZoom="https://virginia.zoom.us/j/94170536877?pwd=OEhXcHZJenhWLzVvNUVvNXBwbXk1dz09";
		this.ws=new WebSocket('ws://'+window.location.host+':8080');								// Open websocket											
		this.ws.onmessage=(e)=>{ this.SocketIn(e); };												// ON INCOMING MESSAGE
		this.ws.onclose=()=>   { console.log('disconnected'); };									// ON CLOSE
		this.ws.onerror=(e)=> { 																	// ON ERROR
			console.log('error',e);
			let str=`<h1 style="color:#ff0000">There was a problem joining the meeting!</h1><p style="color:#000;font-size:14px;">
				Either the meeting server is down, or there may be a firewall blocking your access.<br><br>
				<b>Please contact you meeting's host for help.<b></p>`;
				$("#co-splash2").html(str); 
			};

		this.ws.onopen=()=> { 																		// ON OPEN
			app.ws.send(`P|${app.meetingId}`);														// Request people data	
			console.log('connected');  
			};				
	}	

	SocketIn(event)																				// A WEBSOCKET MESSAGE
	{
		let msg=event.data;																			// Get message
		let v=event.data.split("|");																// Split message
		let id,meeting="";
		if (v[1]) meeting=v[1].split("~")[0];
		
		if (v[0] == "C") {																			// If chat
			if (meeting != this.meetingId)	return;													// Not this meeting
			id=this.pIndex[v[2]];																	// Get index from id			
			
			this.chats.push({ dir:0, id:id, msg:v[3] });											// Archive
			if ($("#co-textDiv").length) {															// If chat window is open
				$("#co-textDiv").append("<div class='co-textR'>"+v[3]+"</div><br>");				// Add message
				$("#co-textDiv").scrollTop(10000);													// Scroll to bottom
				}
			else{
				this.queue.push({ id:id, msg:v[3] });												// Add to queue
				if ($("#co-qv-0").length) this.ShowQueue();											// Show the message queue, if open	
				$("#co-queue").text(app.queue.length); 												// Reset queue dot length
				$("#co-queue").show();																// Show dot
				let o=this.people[id];																// Point at person
				let str=`New message from<hr><img class="co-avatar" src="${o.pic}">
				<b>${o.firstName} ${o.lastName}</b><br>${o.org}<hr>${v[3]}`;		
				Popup(str,5000);																	// Show popup
				}
			Sound("ding");																			// Ring the bell
			}
		else if (v[0] == "L")	{
			if (meeting != this.meetingId)	return;													// Not this meeting
			let x=v[2]/100*this.bx;																	// Calc x from %
			let y=v[3]/100*this.by;																	// Y
			x=Math.max(0,Math.min(this.bx-avSize,x));												// Cap x to screen
			y=Math.max(0,Math.min(this.by-avSize*2,y));												// Y
			id=this.pIndex[v[1]];																	// Get index from id			
			this.people[id].x=x;	this.people[id].y=y;	this.people[id].stats=v[4];				// Update people object
			$("#co-Av-"+id).animate({ left:x+"px", top:y+"px"});									// Animate icon there
			if (v[4].charAt(0) == "Q")	$("#co-Av-"+id).css("display","none");						// Hide this person if quiet
			else						$("#co-Av-"+id).css("display","block");						// Show them
			if (v[4].match(/^[B|R]/))	this.ArrangePeople(v[4]);									// Arrange people at bar and rooms
			$("#co-Av-"+this.myId).css("display","none");											// Always hide my own avatar
			$("#co-At-"+id).css("display",v[4].match(/^[B|R]/) ? "none" : "block");					// Hide or show name tag
			}
		else if (v[0] == "P") 	this.AddPeople(JSON.parse(v[1]));									// Add people
	}
	
	OnMeMove(x, y, targetId)																	// REACT TO MOVING ME AVATAR
	{
		targetId=targetId.replace(/co-AvMe/,"");													// It's just me
		$("#co-card").remove();																		// Close card if open
		$("#co-chat").remove();																		// Close chat if open
		$("#co-sched").remove();																	// Remove old one
	
		if (targetId.match(/co-Jo-/)) {																// Join a room
			let link=this.rooms[targetId.substr(6)].zoom;											// Get zoom link
			if (!link)	return;																		// Quit if no link set
			this.StartZoom(link);																	// Start a zoom
			this.status="R"+targetId.substr(6);														// Status with room number	
			}
		else if (targetId.match(/co-Rm-/)) {														// In a room
			this.status="R"+targetId.substr(6);														// Status with room number
			}
		else if (targetId == "co-infoDesk")  { this.Chat(this.infoDeskId,true);			return; }	// ON INFO DESK BUTTON
		else if (targetId == "co-attendees") { this.ShowPeople(this.infoDeskId,true);	return; }	// ON PEOPLES BUTTON
		else if (targetId == "co-schedule") {														// ON SCHEDULE BUTTON
			this.ShowSchedule();																	// Show schedule
			return;																					// Quit
			}
		else if (targetId.match(/co-Av-/)) {														// ON A PERSON
			this.ShowCard(targetId.substr(6));														// Show card
			return;																					// Quit
			}
		else if (targetId.match(/co-quiet/)) {														// ON QUIET AREA
			x=$("#co-quiet").offset().left+4;														// Center x
			y=$("#co-quiet").offset().top+4;														// Y
			this.status="Q";																		// In quiet mode
			}
		else if (targetId.match(/co-coffee/)) {														// ON COFFEE BAR
			this.status="B";																		// In coffee bar
			this.people[this.myId].stats="B";														// Update me
			this.StartZoom(this.coffeeZoom);														// Go to the coffee bar zoom	
			}
		else this.status="A";																		// Not in quiet mode
		x=Math.max(0,Math.min(this.bx-avSize,x));													// Cap x to screen
		y=Math.max(0,Math.min(this.by-avSize,y));													// Y
		$("#co-AvMe").animate({ left:x, top:y });													// Animate me there		
		this.ReportLocation(x/this.bx,y/this.by,this.status);										// Report my move
	}

	StartZoom(link)																				// INITIATE ZOOM
	{
		if (window.location.host == "localhost") {
			Popup("Zooming!")
			return;
			}
		let myWin=window.open(link,"_blank","scrollbars=no,toolbar=no,status=no,menubar=no");		// Open zoom link
		setTimeout(function(){ myWin.close(); },10000);												// Close after 10 secs
	}

	ArrangePeople()																				// ARRANGE COFFEE BAR / ROOM MEMBERS
	{
		let i,bar=[];
		let x=$("#co-coffee").offset().left;														// left side of bar
		let w=$("#co-coffee").width()-avSize;														// Width of space
		let x2=$("#co-coffee").offset().left+w;														// Last stool
		let y=this.by-$("#co-coffee").height()-avSize-4;											// On top of bar area
		for (i=0;i<this.people.length;++i) 	if (this.people[i].stats.charAt(0) == "B") bar.push(i);	// Make people array
		for (i=0;i<bar.length;++i) {																// For each barmate
			if (bar[i] == this.myId)	continue;													// Skip me
			$("#co-Av-"+bar[i]).animate({ left:x, top:y},0);										// Move there
			$("#co-At-"+bar[i]).css("display","none");												// Hide me tag
			if (bar.length > 1) x+=w/(bar.length-1);												// Advance
			}
		if (bar.length) {
			if (this.people[this.myId].stats.charAt(0) == "B") $("#co-AvMe").animate({ left:x2, top:y},0); // If I'm at the bar, move me
			else if (bar.length > 1) $("#co-Av-"+(bar[bar.length-1])).animate({ left:x2, top:y},0);		// Move last one
			}
		let o,j,n,ox,y2,rms=[];
		for (i=0;i<this.rooms.length;++i)	rms.push([]);											// Make room arrays
		for (i=0;i<this.people.length;++i) {														// For each person
			o=this.people[i].stats;																	// Point at stats
			if (o.charAt(0) == "R") rms[o.substr(1)].push(i);										// If in a room, add person to it
			}
		for (j=1;j<rms.length;++j) {																// For each room
			ox=$("#co-Rm-"+j).offset().left+4;														// Left side
			x=ox;																					// Start pos
			x2=x+$("#co-Rm-"+j).width()-avSize-8;													// Width of space
			w=avSize+2;																				// Full size spacing
			n=rms[j].length;																		// Number of people
			y2=$("#co-Rm-"+j).offset().top+50;														// Top
			y=$("#co-Rm-"+j).offset().top+$("#co-Rm-"+j).height()-avSize-8;							// Bottom
			w=Math.min(Math.sqrt(((x2-ox)*(y-y2)/n)),avSize+2);										// Set avatar spacing
			if (this.people[this.myId].stats.substr(1) == j)										// If I'm in this room		
				$("#co-AvMe").animate({ left:x, top:y},0),x+=w; 									// Move me in
			for (i=0;i<n;++i) {																		// For person in room
				if (rms[j][i] == this.myId)	continue;												// Skip me
				$("#co-Av-"+rms[j][i]).animate({ left:x, top:y},0);									// Move there
				$("#co-At-"+rms[j][i]).css("display","none");										// Hide me tag
				x+=w;																				// Advance
				if (x > x2)	{ x=ox;	 y-=w; }														// Next row
				if (y < y2)	break;																	// Quit if too many
				}
			}
	}

	ReportLocation(x, y, status="A")															// REPORT LOCATION TO SERVER
	{
		x=(x*100).toFixed(2);																		// Scale x 0-100
		y=(y*100).toFixed(2);																		// y
		if (app.ws)	app.ws.send(`L|${app.people[app.myId].id}|${x}|${y}|${status}`); 				// Send Location message
	}
	
	Draw() 																						// REDRAW
	{
		this.bx=$("body").width(),		this.by=$("body").height();									// Body size
		let x=this.bx*this.scale, y=this.by*this.scale;												// Max
		$("#co-main").width(x);		$("#co-main").height(y);										// Scale div
		let p=$("#co-main").offset();																// Get offset
		$("#co-main").css({ left:Math.max(this.bx-x,p.left), top:Math.max(this.by-y,p.top) });		// Cap to max
		this.ArrangePeople();																		// Arrange people				
	}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// CARDS
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	ShowPeople()																				// SHOW THE ATTENDEES
	{
		let i,selects=[];
		$("#co-chat").remove();																		// Close chat if open
		$("#co-card").remove();																		// Close 
		$("#co-sched").remove();																	// Close
		$("#co-people").remove();																	// Close
	
		let x=$("#co-attendees").offset().left-133;													// Left
		let y=$("#co-attendees").offset().top-50-this.by/2											// Top

		let str=`<div id="co-people" class="co-people" style="left:${x}px;top:${y}px;background-color:#eee">
			<img style="float:right;cursor:pointer;margin-top:5px" src="/img/closedot.png" onclick="$('#co-people').remove()">
			<div style='text-align:center;font-size:18px'><b>Attendees</b></div><br>
			<div id="co-spp"style="overflow-x:hidden;overflow-y:auto;height:calc(100% - 140px);margin-bottom:12px;background-color:#fff;border:1px solid #999">`;
		str+=`</div><table>
			<tr><td>Sort by </td><td><select class="co-is" id="co-sps" style="width:148px">
			<option>None</option><option>Name</option><option>Organization</option></select></td></tr>
			<tr><td>In </td><td><select class="co-is" id="co-spr" style="width:148px"></select></td></tr>	
			<tr><td>Find </td><td><input class="co-is" id="co-spf" style="width:130px;height:21px;" placeholder="Type here"></td></tr></table>`;
		$("body").append(str.replace(/\t|\n|\r/g,""));
		$("#co-people").draggable();
		$("#co-spr").append("<option>Any area</option><option>Hallway</option><option>Coffee bar</option>");
		fillPeople();
		for (i=1;i<this.rooms.length;++i)	$("#co-spr").append("<option>"+this.rooms[i].title+"</option>");
		
		$("#co-spr").on("change",()=>{ fillPeople() });
		$("#co-sps").on("change",()=>{ fillPeople() });
		$("#co-spf").on("change",()=>{ fillPeople() });

		function fillPeople() {																	// FILL PEOPLE TABLE
			let i,o,r,s,str="<br>"
			selects=[];																			// Start fresh
			let room=$("#co-spr").prop("selectedIndex");										// Get room index
			let sort=$("#co-sps").prop("selectedIndex");										// Sort
			let find=$("#co-spf").val();														// Search term
			for (i=0;i<app.people.length;++i) {													// For each person
				o=app.people[i];																// Point at person											
				if (o.stats == "Q")	continue;													// Skip quiet people
				if (find) {																		// Filtering by search
					r=RegExp(find,"i");															// Turn into regex
					s=o.firstName+o.org+o.title+o.ints;											// Search all fields															
					if (!s.match(r)) continue;													// Skip if not a match
					}	
				if (room) {																		// If filtering by zoom
					if ((room == 1) && (o.stats != "A"))				continue;				// Only active people in hallway
					else if ((room == 2) && (o.stats != "B"))			continue;				// Only barmates people in the coffeebar
					else if ((room > 2) && ("R"+(room-2) != o.stats))	continue;				// Show only people in the room
					}
				selects.push({index:i, org:o.org, name:o.lastName });							// Add to selects
				}
			if (sort == 1)		selects.sort((a,b)=>{ return (a.name > b.name) ? 1 : -1 });		// Sort by name
			else if (sort == 2)	selects.sort((a,b)=>{ return (a.org > b.org) ? 1 : -1 });		// Sort by org

			for (i=0;i<selects.length;++i) {													// For each selected person
				let o=app.people[selects[i].index];												// Point at person
				str+=`<div style="vertical-align:top"><div style="float:left;text-align:left;width:100%">
				<img id="co-spi-${selects[i].index}" style="cursor:pointer;float:left;width:40px;height:40px;margin:0 8px 16px 4px;
				border:1px solid #333;border-radius:64px;width:${avSize}px" 
				src="${o.pic}"><b>${o.firstName} ${o.lastName}</b><br>${o.title}<br>${o.org}</div></div>`;
				}
			$("#co-spp").html(str);																// Add to listing
			$("[id^=co-spi-]").on("click",(e)=>{												// ON PIC CLICK
				let id=e.target.id.substr(7)-0;													// Get index
				app.ShowCard(id);																// Show card
				});
			}
	}

	ShowQueue()																					// SHOW QUEUE DOT
	{
		let i,flip=false;
		$("#co-chat").remove();																		// Close chat if open
		$("#co-card").remove();																		// Close card if open
		$("#co-sched").remove();																	// Remove old one
		let x=$("#co-AvMe").css("left").replace("px","")-150+avSize/2;								// Get my pos x
		let y=$("#co-AvMe").css("top").replace("px","")-326-12;										// Y
		if (y < 12) flip=true,y=y-0+avSize+326+24;													// Flip it
		if (x < 12)	x=12;																			// Too far left
		if (x > this.bx-312)	x=this.bx-312;														// Too far right
		let str=`<div id='co-card' class='co-qlist' style='left:${x}px;top:${y}px'>
			<b style='font-size:18px'>Missed messages</b><hr><br>
			<div style="overflow-x:hidden;overflow-y:auto;height:calc(100% - 50px)">`;
			for (i=0;i<this.queue.length;++i) {
				str+=`<div id="co-qv-${i}" style="vertical-align:top">
				<div style="float:left;text-align:left;width:100%">
					<img id="co-qi-${i}" style="float:left;width:40px;margin:0 8px 8px 4px;border:1px solid #333;border-radius:64px;width:${avSize}px" 
					src="${this.people[this.queue[i].id].pic}">
					<b>${this.people[this.queue[i].id].firstName} ${this.people[this.queue[i].id].lastName}</b></br>
					<i>${this.queue[i].msg}</i>
					<img src="img/deletebut.png" id="co-qd-${i}" style="float:right;cursor:pointer;margin:-8px 8px 0 0"></div></div>`
				}
			str+="</div>"
			str+=`<div style="position:absolute;left:141px; top:${flip ? "-10" : "323"}px; width:0;height:0; 
				${flip ? "transform: rotate(180deg)" : ""};border-style:solid; border-width: 14px 8px 0 8px;
				border-color: #fff transparent transparent transparent"></div>
			</div>`;
		$("body").append(str.replace(/\t|\n|\r/g,""));
	
		$("[id^=co-qd-]").on("click",(e)=>{															// ON DELETE CLICK
			let i=e.target.id.substr(6)-0;															// Get index
			let targetId="co-Av-"+i;																// Recreate id
			$("#co-qv-"+i).remove();																// Kill it
			this.queue.splice(i,1);																	// Remove it
			Sound("delete");																		// Delete sound
			if (this.queue.length) 	$("#co-queue").text(this.queue.length);							// Update count
			else 					$("#co-queue").hide();											// Remove	
			this.ShowQueue();																		// Reshow
			});

		$("[id^=co-qi-]").on("click",(e)=>{															// ON AVATAR CLICK
			let id=e.target.id.substr(6)-0;															// Get id
			app.Chat(app.queue[id].id);																// Show card
			});
	}

	ShowCard(id)																				// SHOW BUSINESS CARD
	{
		let x=$("#co-Av-"+id).css("left").replace("px","")-175+avSize/2;;							// Center X on avatar 
		let y=$("#co-Av-"+id).css("top").replace("px","")-200-12;									// Y atop avatar
		$("#co-card").remove();																		// Close card if open
		$("#co-chat").remove();																		// Close chat if open
		$("#co-sched").remove();																	// Close schedule if open
		let flip=false;																				// Position above avatar
		if (y< 12) flip=true,y=(y-0+avSize+224);													// Flip to bottom
		if (x < 12)	x=12;																			// Too far left
		if (x > this.bx-362)	x=this.bx-362;														// Too far right
		let o=this.people[id];																		// Point at person
		let str=`<div id='co-card' class='co-card' style='left:${x}px;top:${y}px'>
			<b style='font-size:24px'>${o.firstName} ${o.lastName}</b><br><br>
			<b>${o.title}<br>${o.org}</b><br><br>Interests: ${o.ints}<br>
			<p style="position:absolute;left:24px;bottom:0">`;
			if (o.li) {
				o.li=o.li.replace(/https:\/\//,"");
				o.li=o.li.replace(/linkedin.com\//,"");
				o.li=o.li.replace(/in\//,"");
				str+=`<a href="https://link		if (x < 12)	x=12;																			// Too faredin.com/in/${o.li}" target="_blank">
					<img style="cursor:pointer"src="img/LI-Logo.png" height="14px"></a>`;
				}
			str+=`</p><button id="co-chatBut" style="position:absolute; left:225px; bottom:14px; cursor:pointer;
				border-radius:20px; width:100px; background-color:#2d6ab3; color:#fff">
				Chat now!</button> &nbsp;&nbsp
				<div style="position:absolute;left:166px; top:${flip ? "-10" : "195"}px; width:0;height:0; 
				${flip ? "transform: rotate(180deg)" : ""};
				border-style:solid; border-width: 14px 8px 0 8px;
    			border-color: #fff transparent transparent transparent;"></div>
			</div>`;
		$("body").append(str.replace(/\t|\n|\r/g,""));												// Add dialog
		$("#co-chatBut").on("click",()=>{ this.Chat(id)} );											// ON CHAT BUTTON CLICK
	}

	Chat(id, infoDesk)																			// CHAT CLIENT
	{
		let i,flip=false;
		let ox=$("#co-Av-"+id).offset().left;														// Avatar left
		let oy=$("#co-Av-"+id).offset().top;														// Top
		if (infoDesk) {																				// If an info desk query
			ox=$("#co-infoDesk").offset().left-7;													// Desk left
			oy=$("#co-infoDesk").offset().top-4														// Top
			}		
		let x=ox-150+avSize/2;																		// Center X on avatar 
		let y=oy-370-12;																			// Y atop avatar
		if (y < 12) flip=true,y=(y-0+avSize+394);													// Flip it
		if (x < 12)	x=12;																			// Too far left
		if (x > this.bx-312)	x=this.bx-312;														// Too far right

		let o=this.people[id];																		// Point at person
		$("#co-card").remove();																		// Remove old one
		$("#co-chat").remove();																		// Remove old one
		$("#co-sched").remove();																	// Remove old one
			$("#co-AvMe").animate({ left:(ox-0+avSize), top:oy});											// Animate me there
		this.ReportLocation((ox-0+avSize)/this.bx,oy/this.by,"A");									// Report my move
			let str=`<div id='co-chat' class='co-chat' style='left:${x}px;top:${y}px'>
			<b>Chat with ${this.people[id].firstName}</b><hr>
			<button id="co-zoomBut"  style="cursor:pointer; border-radius:20px; background-color:#2d6ab3; color:#fff">Send Zoom invite</button>
			<div id="co-textDiv" style="height:235px;overflow-x:hidden;overflow-y:auto;margin-top:8px;border:1px solid #999;border-radius:6px;padding:0 4px"></div>														
			<div style="position:absolute;top:330px;left:24px">
				<input  id="revText" placeholder="Type here..." class='co-is' style='width:202px'>			
				<img id='revTextBut'src='img/sendtext.png' style='vertical-align:-7px;margin-left:5px;cursor:pointer'>
				</div>	
			<div style="position:absolute;left:141px; top:${flip ? "-10" : "365"}px; width:0;height:0; 
				${flip ? "transform: rotate(180deg)" : ""};
				border-style:solid; border-width: 14px 8px 0 8px;
    			border-color: #fff transparent transparent transparent;"></div>
			</div>`;
		$("body").append(str.replace(/\t|\n|\r/g,""));												// Add chatbox
	
		for (i=0;i<this.chats.length;++i) {															// For each chat in archive
			if (this.chats[i].id == id) 															// If it's whom I'm chatting with
				$("#co-textDiv").append(`<div class="co-text${this.chats[i].dir ? "S" : "R"}">${this.chats[i].msg}</div><br>`);	// Add message
			}
		$("#co-textDiv").scrollTop(10000);															// Scroll to bottom
		
		for (i=0;i<this.queue.length;++i) {															// For item in message box
			if (this.queue[i].id == id) 															// If it's whom I'm chatting with
				this.queue.splice(i,1);																// Remove it
			if (this.queue.length) 			$("#co-queue").text(this.queue.length);					// Update count
			else 							$("#co-queue").hide();									// Remove	
			}
	
		$("#revText").on("change",   ()=>{ sendChat(); });											// ON TEXT ENTER
		$("#revTextBut").on("click", ()=>{ sendChat(); });											// ON SEND CLICK 
		$("#co-zoomBut").on("click", ()=>{ 															// ON ZOOM BUT CLICK
			let str=`Click <img src="img/zoomblue.png" style="width:24px;cursor:pointer;vertical-align:-6px"
			onclick="app.StartZoom('${app.people[app.myId].zoom}')"> to join`;
			sendChat(str)
			})					
	
		function sendChat(msg) {																	// TEXT CHATTING
			let s=msg ? msg : $("#revText").val();													// Get text fron msg or textbox
			if (s) {																				// If something there
				$("#co-textDiv").append("<div class='co-textS'>"+s+"</div>");						// Add to display 
				let fid=app.people[app.myId].id;													// From id (me)
				let tid=app.people[id].id															// To id
				app.ws.send(`C|${fid}|${tid}|${s}`);												// Send chat message
				app.chats.push({ dir:1, id:id, msg:s});												// Archive
				$("#co-textDiv").scrollTop(10000);													// Scroll to bottom
				}
			$("#revText").val("");																	// Clear input
			}	
		}
	
	ShowSchedule()																				// SHOW EVENT SCHEDULE
	{
		$("#co-sched").remove(); 																	// Remove old schedule
		let b=$("#co-schedule").offset();															// Get offset
		let str=`<div id="co-sched" class="co-card"' style="top:12px; display:none;
			left:${$("#co-hall").offset().left+12}px;
			width:${$("#co-hall").width()-68}px; height:${b.top-80}px">
			<b style="'font-size:30px">Event schedule</b>
			<img style="float:right;cursor:pointer" src="/img/closedot.png" onclick="$('#co-sched').remove()">
			<hr><br>
			<br>Events listed here, along with button to add them to attendee's personal schedule.
			</div>`;
		$("body").append(str.replace(/\t|\n|\r/g,""));												// Add schedule
		$("#co-sched").show("slide",{ direction:"down" });											// Slide up
	}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// DATA
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	AddPeople(people)																				// ADD PEOPLE TO MEETING
	{
		let i,o,str="";
		this.people=people;																				// Set data
		for (i=0;i<people.length;++i) {																	// For each person
			let id=people[i].id.split("~")[1];															// Split id out
			this.pIndex[people[i].id]=i;																// Save index by full id
			o=this.people[i];																			// Point at them
			o.x=Math.max(0,Math.min(o.x,95));															// Cap x to screen
			o.y=Math.max(0,Math.min(o.y,95));															// Cap x to screen
			if (!this.people[i].pic)	this.people[i].pic="avyou.png";									// Use generic pic
			str+=`<div class="co-avatar" id="co-Av-${i}" style="top:${o.y}%;left:${o.x}%"> 
			<img src="${o.pic}" style="width:${avSize-4}px;height:${avSize-4}px;border:2px solid #fff;border-radius:64px;"><br>
			<div id="co-At-${i}">${o.firstName}<br>${o.lastName}</div></div>`;							// Add person
			}
		str+=`<div class="co-me" id="co-AvMe"><img src="avme.png" width="100%"><div id="co-queue" class="co-qNum"></div>`;	// Add me
		$("body").append(str);																			// Add to body

		this.infoDeskId=this.pIndex[this.meetingId+"~"+this.infoDeskId];								// Convert info id to index
		$("[id^=co-Av-]").on("click", (e)=>{ this.ShowCard(e.currentTarget.id.substr(6)); }); 			// ON PERSON CLICK
		$("[id^=co-Av-]").droppable( { drop:(e)=>{ this.ShowCard(e.target.id.substr(6)); }}); 			// ON DROP ON PERSON
		$("#co-AvMe").draggable({ containment:"window", stop:(e,ui)=>{ 
			this.ReportLocation(ui.position.left/this.bx,ui.position.top/this.by);						// Report my move
			}})
		$("#co-AvMe").on("click", (e)=>{ this.ShowQueue();	}); 										// ON ME CLICK
		}

	InitProject(meetingId, myId)																	// INIT PROJECT DATA
	{
		let i,j,o,row,n,w,h,x,y;
		this.meetingId=""+meetingId;																	// Project id
		this.myId=myId;																					// My id
		let nCols=4,nRows=4;																			// Venue shape																	
		this.bx=$("body").width(),		this.by=$("body").height();										// Body size
	
		let hallway=`<div style="position:absolute;top:calc(100vh - 66px - var(--mobileOff));width:calc(50% - 36px);padding:0 12px">
			<img src="img/quietarea.png" id="co-quiet" style="height:${avSize-0+8}px;cursor:pointer;float:left;margin-bottom:8px">
			<img id="co-coffee" style="position:absolute;left:calc(50% - 100px);top:8px" src="img/coffeebar.png">
			<div style="float:right;margin-top:18px">			
				<img src="img/schedule.png" id="co-schedule"  style="height:32px;cursor:pointer;margin-right:12px">
				<img src="img/people.png" 	id="co-attendees" style="height:28px;cursor:pointer;margin-right:12px">
				<img src="img/info.png"  	id="co-infoDesk"  style="height:32px;cursor:pointer">;
			</div></div>`
		
		this.rooms=[
			{ rug:"img/carpet1.jpg", zoom:"", title:"<br><img src='img/wlogo.png' style='width:30%'>", cs:2, ce:3, rs:1, re:5, content:hallway, use:"hall", floor:"1",  },
			{ rug:"img/carpet3.jpg", zoom:"https://zoom.us/j/98542348220?pwd=N3IzWDNKaGRaT3pXcThOQ21wL1NCQT09", title:"Main room", cs:1, ce:1, rs:1, re:3, use:"room", floor:"1",
				content:`<div style="font-size:18px;background-color:#42b97a;color:#fff;margin:24px;padding:12px;border:2px solid #fff;border-radius:8px;pointer-events:none; ">
				Please join SITE president<br><b>Elizabeth Langren</b><br><br>
				<img src="liz.jpg" style="width:33%;border:2px solid #fff;border-radius:300px"><br>
				for the keynote speech<br> in <b></b>15</b></15> minutes</div>` },
			{ rug:"img/carpet3.jpg", zoom:"https://zoom.us/j/98542348220?pwd=N3IzWDNKaGRaT3pXcThOQ21wL1NCQT09", title:"Room A", cs:1, ce:1, rs:3, re:3, use:"room", floor:"1",
				 content:`<div class="co-roomTitle"><b>The Flipped Classroom</b><br>Glen Bull</div>` },
			{ rug:"img/carpet3.jpg", zoom:"https://zoom.us/j/98542348220?pwd=N3IzWDNKaGRaT3pXcThOQ21wL1NCQT09", title:"Room B", cs:1, ce:1, rs:4, re:4, use:"room", floor:"1",
				content:`<div class="co-roomTitle"><b>GIS in the Class</b><br>Thomas Hammond</div>` },
			{ rug:"img/carpet3.jpg", zoom:"https://zoom.us/j/98542348220?pwd=N3IzWDNKaGRaT3pXcThOQ21wL1NCQT09", title:"Room C", cs:3, ce:3, rs:1, re:1, use:"room", floor:"1",
				content:`<div class="co-roomTitle"><b>Graphing Calculators</b></Graphing><br>Joe Garofalo</div>` },
			{ rug:"img/carpet3.jpg", zoom:"https://zoom.us/j/98542348220?pwd=N3IzWDNKaGRaT3pXcThOQ21wL1NCQT09", title:"Room D", cs:3, ce:3, rs:2, re:2, use:"room", floor:"1",
				 content:`<div class="co-roomTitle""><b>Birds of a Feather</b><br>Computer animation</div>` },
			{ rug:"img/carpet3.jpg", zoom:"https://zoom.us/j/98542348220?pwd=N3IzWDNKaGRaT3pXcThOQ21wL1NCQT09", title:"Room E", cs:3, ce:3, rs:3, re:3, use:"room", floor:"1",
				content:"" },
			{ rug:"img/carpet3.jpg", zoom:"https://zoom.us/j/98542348220?pwd=N3IzWDNKaGRaT3pXcThOQ21wL1NCQT09", title:"Room F", cs:3, ce:3, rs:4, re:4, use:"room", floor:"1",
				content:"" }
			];

		if (this.meetingId.toLowerCase() == "aims") {
			this.rooms=[
			{ rug:"img/carpet1.jpg", zoom:"", title:"<img src='misc/aimslogo.jpg' style='width:100%'>", cs:2, ce:2, rs:1, re:5, content:hallway, use:"hall"  },
			{ rug:"img/carpet3.jpg", zoom:"https://zoom.us/j/98542348220?pwd=N3IzWDNKaGRaT3pXcThOQ21wL1NCQT09", title:"Main room",  cs:1, ce:1, rs:1, re:3, use:"room",
				content:`<div style="font-size:18px;background-image:url('misc/aimsbg.jpg');background-size:cover;color:#fff;margin:10%;padding:12px;border:2px solid #fff;border-radius:8px;pointer-events:none; ">
				Please join GVG chairman<br><b>Micheal Cronk</b><br><br>
				<img src="https://aimsalliance.org/wp-content/uploads/2018/03/Cronk2-300x300.jpg" style="width:33%;border:2px solid #fff;border-radius:300px"><br>
				for the keynote speech<br> in <b></b>15</b></15> minutes</div>` },
			{ rug:"img/carpet3.jpg", zoom:"https://zoom.us/j/98542348220?pwd=N3IzWDNKaGRaT3pXcThOQ21wL1NCQT09", title:"Room A", cs:1, ce:1, rs:3, re:3, use:"room",
				 content:`<div class="co-roomTitle">Panel discussion:<br>Standards-based IP adoption</div>` },
			{ rug:"img/carpet3.jpg", zoom:"https://zoom.us/j/98542348220?pwd=N3IzWDNKaGRaT3pXcThOQ21wL1NCQT09", title:"Room B", cs:1, ce:1, rs:4, re:4, use:"room",
				content:`<div class="co-roomTitle">SMPTE ST 2110<br>suite of standards</div>` },
			{ rug:"img/carpet3.jpg", zoom:"https://zoom.us/j/98542348220?pwd=N3IzWDNKaGRaT3pXcThOQ21wL1NCQT09", title:"Room C", cs:3, ce:3, rs:1, re:1, use:"room",
				content:`<div class="co-roomTitle">AMWA NMOS<br>Technology stack</div>` },
			{ rug:"img/carpet3.jpg", zoom:"https://zoom.us/j/98542348220?pwd=N3IzWDNKaGRaT3pXcThOQ21wL1NCQT09", title:"Room D", cs:3, ce:3, rs:2, re:2, use:"room",
				 content:`<div class="co-roomTitle"">improving media workflows<br>for deployment</div>` },
			{ rug:"img/carpet3.jpg", zoom:"https://zoom.us/j/98542348220?pwd=N3IzWDNKaGRaT3pXcThOQ21wL1NCQT09", title:"Room E", cs:3, ce:3, rs:3, re:3, use:"room",
				content:`<div class="co-roomTitle">Proposed IPMX<br>specification</div>` },
			{ rug:"img/carpet3.jpg", zoom:"https://zoom.us/j/98542348220?pwd=N3IzWDNKaGRaT3pXcThOQ21wL1NCQT09", title:"Room F", cs:3, ce:3, rs:4, re:4, use:"room", floor:"1",
				content:"" }
				];
			}
		this.venue=`<div id="co-grid" class="co-venue">`;
		o=this.rooms[0];
		this.venue+=`<div class="co-room" id="co-hall" style="grid-column-start:${o.cs};grid-column-end:${o.ce};grid-row-start:${o.rs};grid-row-end:${o.re};
		background-image:url('${o.rug}')">
		${o.title}${o.content}</div>`;
		for (i=1;i<this.rooms.length;++i) {														// For each room
			o=this.rooms[i];																	// Point at it
			w=this.bx/nCols*(o.ce-o.cs+1);														// Room width
			h=this.by/nRows*(o.re-o.rs+1)-26;													// Height
			y=(o.rs > 1) ? this.by/nRows*o.rs : 0												// Set top
	
			this.venue+=`<div class="co-room" style=";grid-column-start:${o.cs};grid-column-end:${o.ce};grid-row-start:${o.rs};grid-row-end:${o.re};
				background-image:url('${o.rug}')">
				<div id="co-Rm-${i}" style="position:relative;height:100%">
				<div class="co-roomHdr"><div style="display:inline-block;margin-left:48px">${o.title}</div>
					<div id="co-Jo-${i}" class="co-bs" style="float:right;width:32px;margin:1px 8px 0 0">Join</div>
					</div>
				${o.content}</div></div>`;
			}
		this.venue+=`</div></div>`;
		$("#co-main").append(this.venue.replace(/\t|\n|\r/g,""));										// Add venue
	
		$("#co-help").on("click",     (e)=>{ this.ShowHelp(); }); 										// ON HELPN
		$("#co-zoomIn").on("click",   (e)=>{ this.scale=Math.min(4,this.scale+.5); this.Draw(); }); 	// ON ZOOM IN
		$("#co-zoomOut").on("click",  (e)=>{ this.scale=Math.max(1,this.scale-.5); this.Draw(); }); 	// ON ZOOM OUT
		$("#co-grid").on("click", 	  (e)=>{ this.OnMeMove(e.pageX-30,e.pageY-30,e.target.id) }); 		// ON GRID CLICK
		$("[id^=co-Jo-]").on("click", (e)=>{ this.OnMeMove(e.pageX-30,e.pageY-70,e.target.id) }); 		// ON JOIN CLICK
		$("[id^=co-Jo-]").droppable({ drop:(e)=>{ this.OnMeMove(e.pageX-30,e.pageY-70,e.target.id) }}); // ON DROP ON  ROOM
	}

} // APP CLASS CLOSURE

// HELPERS //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////	

	function trace(msg, p1, p2, p3, p4)										// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function Sound(sound, mute)																		// PLAY SOUND
	{
		let snd=new Audio();																			// Init audio object
		if (sound.match(/\.mp3/i))		snd=new Audio(sound)											// If an MP3 file
		else							snd=new Audio("img/"+sound+".mp3");								// Use built in mp3
		if (!mute)	{																					// If not initing or muting	
			snd.volume=100/100;																			// Set volume
			snd.play();																					// Play it
			}
		}

	function Popup(msg, time, div)																	// TIMED POPUP
	{
		let str="";
		$("#co-popupDiv").remove();																		// Kill old one, if any
		str+="<div id='co-popupDiv' class='co-popup'>"; 												// Add div
		if (time == -1) {																				// If has close but
			time=100000;																				// Increase time
			str+="<img id='pu-close' src='img/closedot.gif' style='float:right;cursor:pointer'>";		// Add close button
			}
		str+=msg+"</div>"; 																				// Add div
		$(div ? "#"+div : "body").append(str);															// Add popup to div or body
		$("#pu-close").click(function() { $("#co-popupDiv").remove(); });								// Remove on click of close but
		$("#co-popupDiv").fadeIn(500).delay(time ? time : 2000).fadeOut(500)							// Animate in and out		
	}

	function trace2(msg, p1, p2, p3, p4)										// CONSOLE 
	{
		trace(msg);
		$("#co-Rm-0").text(">"+msg+"<")
	}

</script>
</body>
</html>
